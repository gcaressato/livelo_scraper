name: Livelo Analytics | Firebase Integrado
on:
  schedule:
    - cron: '0 10 * * *'  # 7h Brasil = 10h UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read
  deployments: write

jobs:
  # JOB 1: PIPELINE PRINCIPAL (Scraping + AnÃ¡lise + GitHub Pages)
  pipeline_principal:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      pipeline_success: ${{ steps.validation.outputs.success }}
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar dependÃªncias principais
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy requests
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Criar diretÃ³rios necessÃ¡rios
        run: |
          mkdir -p logs
          mkdir -p public
          
      - name: Executar pipeline principal (main.py)
        run: |
          echo "ğŸš€ Iniciando pipeline Livelo Analytics..."
          python main.py 2>&1 | tee pipeline.log
          echo "PIPELINE_STATUS=$?" >> $GITHUB_ENV
        continue-on-error: true
          
      - name: ValidaÃ§Ã£o rigorosa dos resultados
        id: validation
        run: |
          echo "ğŸ“Š Validando resultados do pipeline..."
          
          if [ "$PIPELINE_STATUS" = "0" ]; then
            echo "âœ… Pipeline executado com sucesso"
            echo "PIPELINE_OK=true" >> $GITHUB_ENV
          else
            echo "âŒ Pipeline falhou - saindo imediatamente"
            echo "PIPELINE_OK=false" >> $GITHUB_ENV
            exit 1
          fi
          
          # âœ… VERIFICAR ARQUIVOS NA RAIZ (conforme solicitado)
          if [ -f "public/index.html" ] && [ -f "livelo_parceiros.xlsx" ]; then
            echo "âœ… Arquivos principais encontrados"
            echo "ğŸ“„ HTML: public/index.html ($(stat -c%s public/index.html) bytes)"
            echo "ğŸ“„ XLSX: livelo_parceiros.xlsx ($(stat -c%s livelo_parceiros.xlsx) bytes)"
            echo "FILES_OK=true" >> $GITHUB_ENV
          else
            echo "âŒ Arquivos principais ausentes"
            echo "ğŸ“ Verificando estrutura atual:"
            ls -la
            echo "ğŸ“ ConteÃºdo da pasta public:"
            ls -la public/ 2>/dev/null || echo "Pasta public nÃ£o encontrada"
            echo "FILES_OK=false" >> $GITHUB_ENV
            exit 1
          fi
          
          # Verificar tamanho do HTML
          if [ -f "public/index.html" ]; then
            size=$(stat -c%s "public/index.html" 2>/dev/null || echo "0")
            if [ "$size" -gt 50000 ]; then
              echo "âœ… HTML vÃ¡lido: $size bytes"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ HTML muito pequeno: $size bytes"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi

      - name: ğŸ” Substituir placeholders Firebase no Service Worker
        if: env.PIPELINE_OK == 'true'
        run: |
          echo "ğŸ”§ Substituindo placeholders no firebase-messaging-sw.js..."
          
          if [ -f "public/firebase-messaging-sw.js" ]; then
            # Fazer backup do original
            cp public/firebase-messaging-sw.js public/firebase-messaging-sw.js.backup
            
            # Substituir placeholders com sed
            sed -i 's/{{FIREBASE_API_KEY}}/${{ secrets.FIREBASE_API_KEY }}/g' public/firebase-messaging-sw.js
            sed -i 's/{{FIREBASE_AUTH_DOMAIN}}/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' public/firebase-messaging-sw.js
            sed -i 's/{{FIREBASE_PROJECT_ID}}/${{ secrets.FIREBASE_PROJECT_ID }}/g' public/firebase-messaging-sw.js
            sed -i 's/{{FIREBASE_STORAGE_BUCKET}}/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' public/firebase-messaging-sw.js
            sed -i 's/{{FIREBASE_MESSAGING_SENDER_ID}}/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' public/firebase-messaging-sw.js
            sed -i 's/{{FIREBASE_APP_ID}}/${{ secrets.FIREBASE_APP_ID }}/g' public/firebase-messaging-sw.js
            
            echo "âœ… Placeholders substituÃ­dos no Service Worker"
          else
            echo "âš ï¸ Arquivo public/firebase-messaging-sw.js nÃ£o encontrado"
          fi
      
      - name: ğŸ” Substituir placeholders Firebase no config runtime
        if: env.PIPELINE_OK == 'true'
        run: |
          echo "ğŸ”§ Substituindo placeholders no firebase-config-runtime.js..."
          
          if [ -f "firebase-config-runtime.js" ]; then
            # Fazer backup do original
            cp firebase-config-runtime.js firebase-config-runtime.js.backup
            
            # Substituir placeholders
            sed -i 's/{{FIREBASE_API_KEY}}/${{ secrets.FIREBASE_API_KEY }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_AUTH_DOMAIN}}/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_PROJECT_ID}}/${{ secrets.FIREBASE_PROJECT_ID }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_STORAGE_BUCKET}}/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_MESSAGING_SENDER_ID}}/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_APP_ID}}/${{ secrets.FIREBASE_APP_ID }}/g' firebase-config-runtime.js
            sed -i 's/{{FIREBASE_VAPID_KEY}}/${{ secrets.FIREBASE_VAPID_KEY }}/g' firebase-config-runtime.js
            
            echo "âœ… Placeholders substituÃ­dos no config runtime"
          else
            echo "âš ï¸ Arquivo firebase-config-runtime.js nÃ£o encontrado"
          fi
      
      - name: ğŸ” Substituir placeholders Firebase em outros arquivos
        if: env.PIPELINE_OK == 'true'
        run: |
          echo "ğŸ”§ Verificando outros arquivos Firebase..."
          
          # Verificar e substituir em sender/firebase-config.js se existir
          if [ -f "sender/firebase-config.js" ]; then
            echo "ğŸ“„ Processando sender/firebase-config.js..."
            cp sender/firebase-config.js sender/firebase-config.js.backup
            
            sed -i 's/{{FIREBASE_API_KEY}}/${{ secrets.FIREBASE_API_KEY }}/g' sender/firebase-config.js
            sed -i 's/{{FIREBASE_AUTH_DOMAIN}}/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' sender/firebase-config.js
            sed -i 's/{{FIREBASE_PROJECT_ID}}/${{ secrets.FIREBASE_PROJECT_ID }}/g' sender/firebase-config.js
            sed -i 's/{{FIREBASE_STORAGE_BUCKET}}/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' sender/firebase-config.js
            sed -i 's/{{FIREBASE_MESSAGING_SENDER_ID}}/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' sender/firebase-config.js
            sed -i 's/{{FIREBASE_APP_ID}}/${{ secrets.FIREBASE_APP_ID }}/g' sender/firebase-config.js
            
            echo "âœ… sender/firebase-config.js processado"
          fi
          
          # Verificar outros arquivos .js no public que podem ter placeholders
          find public -name "*.js" -not -name "firebase-messaging-sw.js" | while read -r file; do
            if grep -q "{{FIREBASE" "$file" 2>/dev/null; then
              echo "ğŸ“„ Processando $file..."
              cp "$file" "$file.backup"
              
              sed -i 's/{{FIREBASE_API_KEY}}/${{ secrets.FIREBASE_API_KEY }}/g' "$file"
              sed -i 's/{{FIREBASE_AUTH_DOMAIN}}/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' "$file"
              sed -i 's/{{FIREBASE_PROJECT_ID}}/${{ secrets.FIREBASE_PROJECT_ID }}/g' "$file"
              sed -i 's/{{FIREBASE_STORAGE_BUCKET}}/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' "$file"
              sed -i 's/{{FIREBASE_MESSAGING_SENDER_ID}}/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' "$file"
              sed -i 's/{{FIREBASE_APP_ID}}/${{ secrets.FIREBASE_APP_ID }}/g' "$file"
              sed -i 's/{{FIREBASE_VAPID_KEY}}/${{ secrets.FIREBASE_VAPID_KEY }}/g' "$file"
              
              echo "âœ… $file processado"
            fi
          done
      
      - name: ğŸ” Verificar substituiÃ§Ãµes Firebase
        if: env.PIPELINE_OK == 'true'
        run: |
          echo "ğŸ” Verificando se todas as substituiÃ§Ãµes foram realizadas..."
          
          ERROR_FOUND=false
          
          # Verificar Service Worker
          if [ -f "public/firebase-messaging-sw.js" ]; then
            if grep -q "{{FIREBASE" public/firebase-messaging-sw.js; then
              echo "âŒ ERRO: Placeholders nÃ£o substituÃ­dos no Service Worker:"
              grep "{{FIREBASE" public/firebase-messaging-sw.js || true
              ERROR_FOUND=true
            else
              echo "âœ… Service Worker: Todos os placeholders substituÃ­dos"
              
              # Verificar se a configuraÃ§Ã£o parece vÃ¡lida
              if grep -q "livel-analytics" public/firebase-messaging-sw.js; then
                echo "âœ… Service Worker: ConfiguraÃ§Ã£o Firebase detectada"
              fi
            fi
          fi
          
          # Verificar config runtime
          if [ -f "firebase-config-runtime.js" ]; then
            if grep -q "{{FIREBASE" firebase-config-runtime.js; then
              echo "âŒ ERRO: Placeholders nÃ£o substituÃ­dos no config runtime:"
              grep "{{FIREBASE" firebase-config-runtime.js || true
              ERROR_FOUND=true
            else
              echo "âœ… Config Runtime: Todos os placeholders substituÃ­dos"
            fi
          fi
          
          # Verificar outros arquivos
          find . -name "*.js" -not -path "./node_modules/*" -not -name "*.backup" | while read -r file; do
            if grep -q "{{FIREBASE" "$file" 2>/dev/null; then
              echo "âš ï¸ Placeholders encontrados em: $file"
              grep "{{FIREBASE" "$file" || true
            fi
          done
          
          if [ "$ERROR_FOUND" = true ]; then
            echo "âŒ FALHA: Alguns placeholders nÃ£o foram substituÃ­dos!"
            echo "ğŸ” Verificando se os secrets estÃ£o configurados..."
            
            if [ -z "${{ secrets.FIREBASE_API_KEY }}" ]; then
              echo "âŒ FIREBASE_API_KEY nÃ£o estÃ¡ configurado nos secrets"
            fi
            if [ -z "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
              echo "âŒ FIREBASE_PROJECT_ID nÃ£o estÃ¡ configurado nos secrets"
            fi
            
            echo "ğŸ“‹ Para configurar os secrets:"
            echo "   1. VÃ¡ em Settings > Secrets and Variables > Actions"
            echo "   2. Configure todos os secrets do Firebase"
            echo ""
            echo "âš ï¸ Continuando sem Firebase (funcionalidade opcional)"
          else
            echo "ğŸ‰ Todas as substituiÃ§Ãµes Firebase realizadas com sucesso!"
            
            # Mostrar preview das configuraÃ§Ãµes (sem revelar valores completos)
            echo ""
            echo "ğŸ“‹ Preview das configuraÃ§Ãµes aplicadas:"
            echo "   - API Key: $(echo '${{ secrets.FIREBASE_API_KEY }}' | cut -c1-10)..."
            echo "   - Project ID: ${{ secrets.FIREBASE_PROJECT_ID }}"
            echo "   - Messaging Sender: ${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}"
          fi
      
      - name: ğŸ“ Copiar firebase-config-runtime.js para public
        if: env.PIPELINE_OK == 'true'
        run: |
          echo "ğŸ“„ Copiando firebase-config-runtime.js para public/..."
          
          if [ -f "firebase-config-runtime.js" ]; then
            cp firebase-config-runtime.js public/firebase-config-runtime.js
            echo "âœ… firebase-config-runtime.js copiado para public/"
          else
            echo "âš ï¸ firebase-config-runtime.js nÃ£o encontrado na raiz"
          fi
        
      - name: Preparar arquivos para GitHub Pages
        run: |
          echo "ğŸ“ Preparando arquivos para GitHub Pages..."
          
          # Criar estrutura limpa para GitHub Pages
          mkdir -p _site
          
          # âœ… COPIAR APENAS O NECESSÃRIO (SEM DUPLICATAS)
          echo "ğŸ“„ Copiando public/index.html â†’ _site/index.html"
          cp public/index.html _site/index.html
          
          # âœ… MANTER XLSX NA RAIZ CONFORME SOLICITADO
          echo "ğŸ“„ Garantindo livelo_parceiros.xlsx na raiz para consumo"
          if [ -f "livelo_parceiros.xlsx" ]; then
            echo "âœ… livelo_parceiros.xlsx encontrado na raiz ($(stat -c%s livelo_parceiros.xlsx) bytes)"
            # Copiar para _site tambÃ©m para GitHub Pages acessar
            cp livelo_parceiros.xlsx _site/livelo_parceiros.xlsx
            echo "ğŸ“„ livelo_parceiros.xlsx copiado para _site/ para GitHub Pages"
          else
            echo "âŒ ERRO: livelo_parceiros.xlsx nÃ£o encontrado na raiz!"
            exit 1
          fi
          
          # âœ… COPIAR OUTROS ARQUIVOS DO PUBLIC (Firebase, manifest, etc.)
          echo "ğŸ“‚ Copiando arquivos de configuraÃ§Ã£o do public/..."
          find public -name "*.js" -o -name "*.json" -o -name "*.png" -o -name "*.ico" | while read file; do
            if [ -f "$file" ] && [ "$(basename "$file")" != "index.html" ]; then
              cp "$file" "_site/$(basename "$file")"
              echo "ğŸ“„ Copiado: $file â†’ _site/$(basename "$file")"
            fi
          done
          
          echo "âœ… Arquivos preparados para GitHub Pages"
          echo "ğŸ“‚ Estrutura final do _site:"
          ls -la _site/
          
          echo ""
          echo "ğŸ“‹ VERIFICAÃ‡ÃƒO FINAL DOS ARQUIVOS:"
          echo "â”œâ”€ Raiz: livelo_parceiros.xlsx ($([ -f "livelo_parceiros.xlsx" ] && echo "âœ… $(stat -c%s livelo_parceiros.xlsx) bytes" || echo "âŒ AUSENTE"))"
          echo "â”œâ”€ _site: index.html ($([ -f "_site/index.html" ] && echo "âœ… $(stat -c%s _site/index.html) bytes" || echo "âŒ AUSENTE"))"
          echo "â””â”€ _site: livelo_parceiros.xlsx ($([ -f "_site/livelo_parceiros.xlsx" ] && echo "âœ… $(stat -c%s _site/livelo_parceiros.xlsx) bytes" || echo "âŒ AUSENTE"))"
          
      - name: Upload pÃ¡ginas como artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site
          
      - name: Debug artifact content
        run: |
          echo "ğŸ“‹ ConteÃºdo detalhado do artifact (_site):"
          find _site -type f -name "*.html" -exec sh -c 'echo "ğŸ“„ {}: $(wc -c < "{}" | tr -d " ") bytes"' \;
          
          echo ""
          echo "ğŸ“‹ Estrutura completa:"
          find _site -type f | head -20
          
          echo ""
          echo "ğŸ” Verificando se index.html tem conteÃºdo vÃ¡lido:"
          if [ -f "_site/index.html" ]; then
            head -10 _site/index.html
            echo "..."
            echo "Total de linhas: $(wc -l < _site/index.html)"
          else
            echo "âŒ _site/index.html nÃ£o encontrado!"
          fi
          
      - name: Configurar Git e fazer commit
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          timestamp=$(date +"%d/%m/%Y %H:%M")
          commit_hash=$(git rev-parse --short HEAD)
          
          # âœ… ADICIONAR ARQUIVOS MANTENDO XLSX NA RAIZ
          git add -f public/index.html
          git add -f livelo_parceiros.xlsx  # XLSX permanece na raiz
          git add -f *.log 2>/dev/null || true
          
          # âœ… ADICIONAR package-lock.json SE FOI CRIADO
          if [ -f "package-lock.json" ] && [ ! "$(git ls-files package-lock.json)" ]; then
            echo "ğŸ“„ Adicionando package-lock.json ao repositÃ³rio..."
            git add -f package-lock.json
          fi
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a detectada para commit"
          else
            echo "ğŸ“ Fazendo commit das mudanÃ§as..."
            
            # âœ… MENSAGEM ATUALIZADA
            COMMIT_MSG="ğŸ“Š AtualizaÃ§Ã£o Livelo Analytics - $timestamp

            âœ… Pipeline: Sucesso com validaÃ§Ã£o rigorosa
            ğŸ“„ HTML: public/index.html ($(stat -c%s public/index.html 2>/dev/null || echo '0') bytes)
            ğŸ“„ Excel: livelo_parceiros.xlsx NA RAIZ ($(stat -c%s livelo_parceiros.xlsx 2>/dev/null || echo '0') bytes)"
            
            # âœ… ADICIONAR INFO SOBRE package-lock.json SE FOI CRIADO
            if [ -f "package-lock.json" ] && [ ! "$(git ls-files package-lock.json)" ]; then
              COMMIT_MSG="$COMMIT_MSG
            ğŸ“¦ package-lock.json: Gerado automaticamente para CI/CD"
            fi
            
            COMMIT_MSG="$COMMIT_MSG
            ğŸš€ Deploy: GitHub Pages com estrutura limpa
            ğŸ”„ Commit anterior: $commit_hash
            â° Executado: $timestamp"
            
            git commit -m "$COMMIT_MSG"
            
            # Push com retry
            for i in {1..3}; do
              if git push; then
                echo "âœ… Push realizado com sucesso (tentativa $i)"
                break
              else
                echo "âš ï¸ Falha no push (tentativa $i)"
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "âŒ Push falhou apÃ³s 3 tentativas"
                  exit 1
                fi
              fi
            done
          fi

  # JOB 2: DEPLOY GITHUB PAGES (MELHORADO)
  deploy_github_pages:
    needs: pipeline_principal
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.pipeline_principal.outputs.pipeline_success == 'true'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: Verificar artifact antes do deploy
        run: |
          echo "ğŸ” Verificando artifacts disponÃ­veis..."
          echo "Workflow Run ID: ${{ github.run_id }}"
          
      - name: Deploy para GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages
          
      - name: Verificar e aguardar propagaÃ§Ã£o
        run: |
          echo "ğŸš€ Deploy concluÃ­do!"
          echo "ğŸŒ URL: ${{ steps.deployment.outputs.page_url }}"
          echo "ğŸ“‹ Deploy ID: ${{ github.sha }}"
          echo "ğŸ• Deploy timestamp: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          
          # âœ… FORÃ‡A INVALIDAÃ‡ÃƒO DE CACHE
          echo "ğŸ”„ ForÃ§ando invalidaÃ§Ã£o de cache..."
          
          # Aguardar propagaÃ§Ã£o inicial
          echo "â³ Aguardando propagaÃ§Ã£o (45 segundos)..."
          sleep 45
          
          # Tentar fazer requisiÃ§Ãµes com diferentes user-agents para forÃ§ar cache refresh
          echo "ğŸ” Testando disponibilidade do site..."
          
          MAX_ATTEMPTS=6
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Tentativa $ATTEMPT de $MAX_ATTEMPTS..."
            
            # Usar diferentes estratÃ©gias para testar
            if curl -s -f -H "Cache-Control: no-cache" -H "Pragma: no-cache" "${{ steps.deployment.outputs.page_url }}" > /dev/null; then
              echo "âœ… Site estÃ¡ respondendo!"
              
              # Verificar se o HTML contÃ©m dados atualizados
              if curl -s "${{ steps.deployment.outputs.page_url }}" | grep -q "Livelo Analytics Pro"; then
                echo "âœ… ConteÃºdo HTML verificado!"
                break
              else
                echo "âš ï¸ HTML carregado mas conteÃºdo pode estar desatualizado"
              fi
            else
              echo "â³ Site ainda nÃ£o estÃ¡ respondendo, aguardando..."
              sleep 20
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
          
          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "âš ï¸ Site pode levar mais alguns minutos para ficar disponÃ­vel"
            echo "ğŸ’¡ GitHub Pages Ã s vezes demora 5-15 minutos para propagaÃ§Ã£o completa"
            echo "ğŸ” Teste em modo anÃ´nimo ou com Ctrl+F5 para forÃ§ar atualizaÃ§Ã£o"
          else
            echo "ğŸ‰ Deploy verificado e funcionando!"
          fi

  # JOB 3: FIREBASE INTEGRATION (CORRIGIDO PARA EVITAR ERRO DE REDE)
  firebase_integration:
    needs: [pipeline_principal, deploy_github_pages]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always() && needs.pipeline_principal.outputs.pipeline_success == 'true'
    
    steps:
      - name: Checkout para Firebase
        uses: actions/checkout@v4
        
      - name: Setup Node.js para Firebase
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          
      - name: Setup Python para notificaÃ§Ãµes
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: ğŸ”§ Instalar dependÃªncias Firebase (CORRIGIDO)
        run: |
          # âœ… CONFIGURAR NPM PARA MAIOR TOLERÃ‚NCIA A PROBLEMAS DE REDE
          npm config set registry https://registry.npmjs.org/
          npm config set fetch-retry-mintimeout 20000
          npm config set fetch-retry-maxtimeout 120000
          npm config set fetch-retries 5
          npm config set fetch-timeout 60000
          
          echo "ğŸ“¦ Instalando dependÃªncias Firebase com retry..."
          
          # âœ… INSTALAR COM RETRY E FALLBACK (CORRIGIDO)
          RETRY_COUNT=0
          MAX_RETRIES=3
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ”„ Tentativa $(($RETRY_COUNT + 1)) de $MAX_RETRIES..."
            
            if [ -f "package.json" ]; then
              echo "ğŸ“¦ Instalando dependÃªncias do package.json..."
              
              # âœ… VERIFICAR SE EXISTE package-lock.json PRIMEIRO
              if [ -f "package-lock.json" ]; then
                echo "ğŸ” package-lock.json encontrado, usando npm ci..."
                if npm ci --no-audit --no-fund --prefer-offline; then
                  echo "âœ… npm ci executado com sucesso"
                  break
                else
                  echo "âš ï¸ npm ci falhou, tentando npm install..."
                fi
              fi
              
              # âœ… USAR npm install COMO FALLBACK OU MÃ‰TODO PRINCIPAL
              echo "ğŸ”§ Usando npm install..."
              if npm install --no-audit --no-fund --prefer-offline; then
                echo "âœ… npm install executado com sucesso"
                break
              else
                echo "âŒ Falha na instalaÃ§Ã£o via package.json"
              fi
            else
              echo "ğŸ“¦ package.json nÃ£o encontrado, instalando dependÃªncias mÃ­nimas..."
              if npm init -y && npm install --no-audit --no-fund firebase@^9.0.0; then
                echo "âœ… DependÃªncias mÃ­nimas instaladas"
                break
              else
                echo "âŒ Falha na instalaÃ§Ã£o de dependÃªncias mÃ­nimas"
              fi
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "â³ Aguardando 30 segundos antes de tentar novamente..."
              sleep 30
            fi
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "âŒ FALHA: NÃ£o foi possÃ­vel instalar dependÃªncias apÃ³s $MAX_RETRIES tentativas"
            echo "ğŸ”§ FALLBACK: Continuando sem Firebase (funcionalidade opcional)"
            echo "FIREBASE_INSTALL_FAILED=true" >> $GITHUB_ENV
          else
            echo "âœ… DependÃªncias Firebase instaladas com sucesso!"
            echo "FIREBASE_INSTALL_FAILED=false" >> $GITHUB_ENV
          fi
          
          # âœ… INSTALAR FIREBASE-TOOLS GLOBALMENTE (COM FALLBACK)
          if [ "$FIREBASE_INSTALL_FAILED" != "true" ]; then
            echo "ğŸ”§ Instalando firebase-tools globalmente..."
            npm install -g firebase-tools || echo "âš ï¸ Falha ao instalar firebase-tools (nÃ£o crÃ­tico)"
          fi
          
          # âœ… PYTHON DEPENDENCIES (SEMPRE TENTAR)
          echo "ğŸ Instalando dependÃªncias Python..."
          pip install firebase-admin pandas openpyxl || echo "âš ï¸ Falha nas dependÃªncias Python (nÃ£o crÃ­tico)"
          
      - name: Verificar configuraÃ§Ã£o Firebase
        run: |
          echo "ğŸ” Verificando configuraÃ§Ã£o Firebase..."
          
          if [ "$FIREBASE_INSTALL_FAILED" = "true" ]; then
            echo "âš ï¸ InstalaÃ§Ã£o Firebase falhou - Pulando verificaÃ§Ã£o"
            echo "FIREBASE_CONFIGURED=false" >> $GITHUB_ENV
            exit 0
          fi
          
          # âœ… VERIFICAR CONFIGURAÃ‡ÃƒO COMPLETA (AGORA COM SERVICE_ACCOUNT)
          FIREBASE_OK=true
          MISSING_SECRETS=()
          
          # Verificar secrets obrigatÃ³rios
          if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
            echo "âœ… FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}"
          else
            echo "âŒ FIREBASE_PROJECT_ID nÃ£o configurado"
            MISSING_SECRETS+=("FIREBASE_PROJECT_ID")
            FIREBASE_OK=false
          fi
          
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "âœ… FIREBASE_SERVICE_ACCOUNT configurado (mÃ©todo preferido)"
            echo "FIREBASE_AUTH_METHOD=service_account" >> $GITHUB_ENV
          elif [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "âœ… FIREBASE_TOKEN configurado (fallback)"
            echo "FIREBASE_AUTH_METHOD=token" >> $GITHUB_ENV
          else
            echo "âŒ Nenhum mÃ©todo de autenticaÃ§Ã£o configurado"
            MISSING_SECRETS+=("FIREBASE_SERVICE_ACCOUNT ou FIREBASE_TOKEN")
            FIREBASE_OK=false
          fi
          
          # Verificar secrets para frontend (opcionais mas recomendados)
          echo ""
          echo "ğŸ“± Verificando secrets para frontend Firebase:"
          
          FRONTEND_SECRETS=0
          [ -n "${{ secrets.FIREBASE_API_KEY }}" ] && echo "  âœ… FIREBASE_API_KEY" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_API_KEY"
          [ -n "${{ secrets.FIREBASE_AUTH_DOMAIN }}" ] && echo "  âœ… FIREBASE_AUTH_DOMAIN" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_AUTH_DOMAIN"
          [ -n "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}" ] && echo "  âœ… FIREBASE_MESSAGING_SENDER_ID" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_MESSAGING_SENDER_ID"
          [ -n "${{ secrets.FIREBASE_APP_ID }}" ] && echo "  âœ… FIREBASE_APP_ID" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_APP_ID"
          [ -n "${{ secrets.FIREBASE_VAPID_KEY }}" ] && echo "  âœ… FIREBASE_VAPID_KEY" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_VAPID_KEY"
          [ -n "${{ secrets.FIREBASE_STORAGE_BUCKET }}" ] && echo "  âœ… FIREBASE_STORAGE_BUCKET" && ((FRONTEND_SECRETS++)) || echo "  âšª FIREBASE_STORAGE_BUCKET"
          
          echo "ğŸ“Š Frontend secrets configurados: $FRONTEND_SECRETS/6"
          
          if [ "$FIREBASE_OK" = "true" ]; then
            echo ""
            if [ $FRONTEND_SECRETS -ge 4 ]; then
              echo "ğŸ‰ Firebase COMPLETAMENTE configurado! ($FRONTEND_SECRETS/6 secrets frontend)"
              echo "FIREBASE_CONFIGURED=true" >> $GITHUB_ENV
              echo "FIREBASE_FRONTEND_READY=true" >> $GITHUB_ENV
            else
              echo "âœ… Firebase backend configurado, frontend parcial ($FRONTEND_SECRETS/6)"
              echo "FIREBASE_CONFIGURED=true" >> $GITHUB_ENV
              echo "FIREBASE_FRONTEND_READY=false" >> $GITHUB_ENV
            fi
          else
            echo ""
            echo "âŒ Firebase nÃ£o configurado completamente"
            echo "ğŸ”§ Secrets faltando: ${MISSING_SECRETS[*]}"
            echo "FIREBASE_CONFIGURED=false" >> $GITHUB_ENV
            echo "FIREBASE_FRONTEND_READY=false" >> $GITHUB_ENV
          fi
          
      - name: Sincronizar arquivos do pipeline
        run: |
          echo "ğŸ“¥ Sincronizando arquivos do pipeline..."
          git pull origin main || echo "Nenhuma mudanÃ§a para sincronizar"
          
          # âœ… VERIFICAR XLSX NA RAIZ CONFORME SOLICITADO
          if [ -f "public/index.html" ] && [ -f "livelo_parceiros.xlsx" ]; then
            echo "âœ… Arquivos encontrados"
            echo "ğŸ“„ HTML: public/index.html ($(stat -c%s public/index.html) bytes)"
            echo "ğŸ“„ XLSX na raiz: livelo_parceiros.xlsx ($(stat -c%s livelo_parceiros.xlsx) bytes)"
          else
            echo "âŒ Arquivos nÃ£o encontrados apÃ³s sincronizaÃ§Ã£o"
            echo "ğŸ“ Estrutura atual:"
            ls -la
            exit 1
          fi
          
      - name: Executar notificaÃ§Ãµes
        if: env.FIREBASE_CONFIGURED == 'true' && env.FIREBASE_INSTALL_FAILED != 'true'
        run: |
          echo "ğŸ“± Executando sistema de notificaÃ§Ãµes Firebase..."
          
          # âœ… USAR SERVICE_ACCOUNT SE DISPONÃVEL (MAIS ROBUSTO)
          if [ "$FIREBASE_AUTH_METHOD" = "service_account" ]; then
            echo "ğŸ”§ Usando Service Account para autenticaÃ§Ã£o (mÃ©todo robusto)"
          else
            echo "ğŸ”§ Usando Firebase Token para autenticaÃ§Ã£o (mÃ©todo CLI)"
          fi
          
          if [ -f "notification_sender.py" ]; then
            echo "ğŸš€ Iniciando notification_sender.py com configuraÃ§Ã£o completa..."
            timeout 300 python notification_sender.py || echo "âš ï¸ NotificaÃ§Ãµes finalizadas (timeout ou erro nÃ£o crÃ­tico)"
          else
            echo "â„¹ï¸ notification_sender.py nÃ£o encontrado - Criando exemplo bÃ¡sico..."
            
            # âœ… CRIAR SCRIPT DE EXEMPLO SE NÃƒO EXISTIR
            cat > notification_test.py << EOF
import os
print("ğŸ” Testando configuraÃ§Ã£o Firebase...")
print(f"Project ID: {os.environ.get('FIREBASE_PROJECT_ID', 'NÃƒO CONFIGURADO')}")
print(f"Auth Method: {os.environ.get('FIREBASE_AUTH_METHOD', 'DESCONHECIDO')}")
print("âœ… ConfiguraÃ§Ã£o Firebase detectada!")
EOF
            
            python notification_test.py
          fi
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
          FIREBASE_VAPID_KEY: ${{ secrets.FIREBASE_VAPID_KEY }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
          FIREBASE_AUTH_METHOD: ${{ env.FIREBASE_AUTH_METHOD }}
        continue-on-error: true

  # JOB 4: RESUMO FINAL
  summary:
    needs: [pipeline_principal, deploy_github_pages, firebase_integration]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Resumo final da execuÃ§Ã£o
        run: |
          echo ""
          echo "ğŸ‰ RESUMO DA EXECUÃ‡ÃƒO LIVELO ANALYTICS"
          echo "====================================="
          echo "â° ConcluÃ­do: $(date +'%d/%m/%Y %H:%M:%S')"
          echo "ğŸ”— Workflow Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ“Š STATUS DOS JOBS:"
          echo "â”œâ”€ Pipeline Principal: ${{ needs.pipeline_principal.result == 'success' && 'âœ… SUCESSO' || 'âŒ FALHOU' }}"
          echo "â”œâ”€ GitHub Pages: ${{ needs.deploy_github_pages.result == 'success' && 'âœ… SUCESSO' || 'âŒ FALHOU' }}"
          echo "â””â”€ Firebase: ${{ needs.firebase_integration.result == 'success' && 'âœ… SUCESSO' || 'âšª OPCIONAL' }}"
          echo ""
          
          if [ "${{ needs.pipeline_principal.result }}" = "success" ]; then
            echo "ğŸŒ SISTEMA ONLINE:"
            echo "â”œâ”€ GitHub Pages: https://gcaressato.github.io/livelo_scraper/"
            echo "â”œâ”€ âœ… Deploy funcionando conforme confirmado pelo usuÃ¡rio"
            echo "â”œâ”€ ğŸ“„ XLSX na raiz: âœ… livelo_parceiros.xlsx (consumo direto)"
            echo "â”œâ”€ ğŸ“„ HTML: âœ… public/index.html (estrutura correta)"
            
            if [ "${{ needs.deploy_github_pages.result }}" = "success" ]; then
              echo "â”œâ”€ ğŸš€ GitHub Pages: Deploy realizado com sucesso"
              echo "â”œâ”€ ğŸŒ Site acessÃ­vel e funcionando"
            else
              echo "â”œâ”€ âš ï¸ GitHub Pages: Status indeterminado (mas funcionando por verificaÃ§Ã£o manual)"
            fi
            
            if [ "${{ needs.firebase_integration.result }}" = "success" ]; then
              echo "â””â”€ Firebase: âœ… IntegraÃ§Ã£o ativa"
            elif [ "${{ needs.firebase_integration.result }}" = "failure" ]; then
              echo "â””â”€ Firebase: âŒ Falha de instalaÃ§Ã£o (npm/rede) - Funcionalidade opcional"
            else
              echo "â””â”€ Firebase: âšª Status indeterminado - Funcionalidade opcional"
            fi
            
            echo ""
            echo "âœ… SISTEMA PRINCIPAL FUNCIONANDO!"
            echo "ğŸ“‚ Estrutura correta: HTML em public/, XLSX na raiz"
            echo "ğŸŒ Site acessÃ­vel mesmo com problemas opcionais do Firebase"
            echo "::notice::Livelo Analytics ONLINE - Deploy confirmado funcionando"
          else
            echo "âŒ FALHA NO PIPELINE PRINCIPAL!"
            echo "::error::Sistema principal falhou - Verificar logs para diagnÃ³stico"
          fi
