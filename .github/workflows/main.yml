name: Livelo Partners Scraper
on:
  schedule:
    - cron: '0 12 * * *'  # Executa todos os dias Ã s 12:00 UTC
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar dependÃªncias
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy requests
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Verificar ambiente
        run: |
          echo "DiretÃ³rio atual: $(pwd)"
          echo "ConteÃºdo do diretÃ³rio: $(ls -la)"
          
      - name: Criar diretÃ³rios para logs e saÃ­da
        run: |
          mkdir -p logs
          mkdir -p relatorios
          
      - name: Executar scraper diretamente (para depuraÃ§Ã£o)
        run: |
          python livelo_scraper.py 2>&1 | tee scraper_debug.log
        continue-on-error: true
          
      - name: Executar script principal
        run: |
          python main.py 2>&1 | tee output.log
        continue-on-error: true

      # DEBUG - Verificar secrets (SEM EXPOR VALORES)
      - name: Debug configuraÃ§Ãµes Firebase
        run: |
          echo "ğŸ” Verificando secrets (sem expor valores)..."
          echo "API Key presente: $([[ -n '${{ secrets.FIREBASE_API_KEY }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "Project ID presente: $([[ -n '${{ secrets.FIREBASE_PROJECT_ID }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "Sender ID presente: $([[ -n '${{ secrets.FIREBASE_SENDER_ID }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "App ID presente: $([[ -n '${{ secrets.FIREBASE_APP_ID }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "VAPID Key presente: $([[ -n '${{ secrets.FIREBASE_VAPID_KEY }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "Server Key presente: $([[ -n '${{ secrets.FIREBASE_SERVER_KEY }}' ]] && echo 'SIM' || echo 'NÃƒO')"
          echo "Service Account presente: $([[ -n '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' ]] && echo 'SIM' || echo 'NÃƒO')"
        
      # VALIDAÃ‡ÃƒO INTELIGENTE DE DADOS
      - name: Validar qualidade dos dados
        id: validate
        run: |
          python -c "
          import pandas as pd
          from datetime import datetime, timedelta
          import os
          
          success = True
          
          try:
              if not os.path.exists('livelo_parceiros.xlsx'):
                  print('âŒ Arquivo Excel nÃ£o encontrado!')
                  success = False
              else:
                  df = pd.read_excel('livelo_parceiros.xlsx')
                  df['Timestamp'] = pd.to_datetime(df['Timestamp'])
                  latest_date = df['Timestamp'].max()
                  now = datetime.now()
                  
                  if (now - latest_date).total_seconds() > 86400:
                      print(f'âš ï¸ Dados podem estar antigos! Ãšltimo: {latest_date}')
                  
                  if len(df) < 30:
                      print(f'âš ï¸ Poucos dados coletados: {len(df)} registros')
                  else:
                      print(f'âœ… Dados validados: {len(df)} registros, Ãºltimo em {latest_date}')
              
              if not os.path.exists('relatorio_livelo.html'):
                  print('âŒ HTML nÃ£o foi gerado!')
                  success = False
              else:
                  print('âœ… HTML gerado com sucesso')
              
              if success:
                  print('VALIDATION_SUCCESS=true')
              else:
                  print('VALIDATION_FAILED=true')
                  
          except Exception as e:
              print(f'âŒ Erro na validaÃ§Ã£o: {e}')
              print('VALIDATION_ERROR=true')
          " 2>&1 | tee validation.log
        continue-on-error: true
        
      # ============ FIREBASE CONFIGURAÃ‡ÃƒO SIMPLIFICADA ============
      
      - name: Verificar secrets Firebase essenciais
        id: check_firebase
        run: |
          missing_count=0
          
          # Verificar apenas os secrets essenciais para funcionar
          if [[ -z "${{ secrets.FIREBASE_PROJECT_ID }}" ]]; then
            echo "âŒ FIREBASE_PROJECT_ID ausente"
            missing_count=$((missing_count + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_SERVER_KEY }}" ]]; then
            echo "âŒ FIREBASE_SERVER_KEY ausente"
            missing_count=$((missing_count + 1))
          fi
          
          # Verificar tamanho da server key (deve ser longa)
          server_key_length=$(echo -n "${{ secrets.FIREBASE_SERVER_KEY }}" | wc -c)
          if [[ $server_key_length -lt 100 ]]; then
            echo "âš ï¸ FIREBASE_SERVER_KEY muito curta ($server_key_length chars) - deve ter 100+ caracteres"
            echo "ğŸ’¡ Verifique se o secret estÃ¡ correto no GitHub"
            missing_count=$((missing_count + 1))
          fi
          
          if [[ $missing_count -eq 0 ]]; then
            echo "âœ… Firebase bÃ¡sico configurado corretamente"
            echo "FIREBASE_OK=true" >> $GITHUB_OUTPUT
          else
            echo "âŒ $missing_count problemas na configuraÃ§Ã£o Firebase"
            echo "FIREBASE_OK=false" >> $GITHUB_OUTPUT
          fi

      - name: Criar configuraÃ§Ã£o Firebase usando dados estÃ¡ticos
        run: |
          # Usar dados do firebase-config.json existente ao invÃ©s de secrets
          # Isso evita problemas de substituiÃ§Ã£o de placeholders
          
          cat > firebase-config-runtime.js << 'EOF'
          // ConfiguraÃ§Ã£o Firebase (dados estÃ¡ticos do projeto)
          window.firebaseConfig = {
              apiKey: "AIzaSyAibNVfTL0kvG_R3rKYYSnAeQWc5oVBFYk",
              authDomain: "livel-analytics.firebaseapp.com",
              projectId: "livel-analytics",
              storageBucket: "livel-analytics.appspot.com",
              messagingSenderId: "168707812242",
              appId: "1:168707812242:web:59b4c1df4fc553410c6f4b"
          };
          
          // VAPID key seria aqui se fosse necessÃ¡ria
          window.firebaseVapidKey = "BFj3Q_8s8Z_9wQ4kKy4Q8x9QC_6bY7j5P_8mA9k7B3f_EXAMPLE_KEY";
          
          console.log('ğŸ”¥ Firebase config estÃ¡tica carregada:', window.firebaseConfig.projectId);
          EOF
          
          echo "âœ… ConfiguraÃ§Ã£o Firebase estÃ¡tica criada"

      - name: Criar Service Worker Firebase simplificado
        run: |
          cat > sw.js << 'EOF'
          // Service Worker para Firebase Messaging v9
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

          console.log('[SW] Service Worker carregando...');

          const firebaseConfig = {
              apiKey: "AIzaSyAibNVfTL0kvG_R3rKYYSnAeQWc5oVBFYk",
              authDomain: "livel-analytics.firebaseapp.com",
              projectId: "livel-analytics",
              storageBucket: "livel-analytics.appspot.com",
              messagingSenderId: "168707812242",
              appId: "1:168707812242:web:59b4c1df4fc553410c6f4b"
          };

          let messaging;

          try {
              if (!firebase.apps.length) {
                  firebase.initializeApp(firebaseConfig);
              }
              
              messaging = firebase.messaging();
              console.log('[SW] Firebase Messaging inicializado');
              
              messaging.onBackgroundMessage(function(payload) {
                  console.log('[SW] Mensagem em background recebida:', payload);
                  
                  const notificationTitle = payload.notification?.title || 'Livelo Analytics';
                  const notificationOptions = {
                      body: payload.notification?.body || 'Nova oferta disponÃ­vel!',
                      icon: 'https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L',
                      badge: 'https://via.placeholder.com/96x96/ff0a8c/ffffff?text=L',
                      tag: 'livelo-offer',
                      requireInteraction: true,
                      data: payload.data || {},
                      actions: [
                          {
                              action: 'view',
                              title: 'ğŸ‘€ Ver Oferta'
                          },
                          {
                              action: 'dismiss',
                              title: 'âœ–ï¸ Dispensar'
                          }
                      ]
                  };
                  
                  return self.registration.showNotification(notificationTitle, notificationOptions);
              });
              
          } catch (error) {
              console.error('[SW] Erro ao inicializar Firebase:', error);
          }

          self.addEventListener('notificationclick', function(event) {
              console.log('[SW] Clique na notificaÃ§Ã£o:', event.action);
              event.notification.close();
              
              if (event.action === 'view') {
                  event.waitUntil(
                      clients.openWindow('https://gcaressato.github.io/livelo_scraper/')
                  );
              }
          });

          self.addEventListener('activate', function(event) {
              console.log('[SW] Service Worker ativado');
              event.waitUntil(self.clients.claim());
          });

          self.addEventListener('install', function(event) {
              console.log('[SW] Service Worker instalado');
              self.skipWaiting();
          });
          EOF
          
          echo "âœ… Service Worker criado"

      - name: Criar manifest.json
        run: |
          cat > manifest.json << 'EOF'
          {
            "name": "Livelo Analytics Pro",
            "short_name": "Livelo",
            "description": "Dashboard analÃ­tico para ofertas Livelo com notificaÃ§Ãµes push",
            "start_url": "./",
            "scope": "./",
            "display": "standalone",
            "background_color": "#151f4f",
            "theme_color": "#ff0a8c",
            "orientation": "portrait-primary",
            "icons": [
              {
                "src": "https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L",
                "sizes": "192x192",
                "type": "image/png",
                "purpose": "maskable any"
              },
              {
                "src": "https://via.placeholder.com/512x512/ff0a8c/ffffff?text=L", 
                "sizes": "512x512",
                "type": "image/png",
                "purpose": "maskable any"
              }
            ],
            "gcm_sender_id": "168707812242"
          }
          EOF
          
          echo "âœ… Manifest PWA criado"
      
      - name: Enviar notificaÃ§Ãµes push para usuÃ¡rios
        if: steps.check_firebase.outputs.FIREBASE_OK == 'true'
        run: |
          echo "ğŸ”” Iniciando envio de notificaÃ§Ãµes push..."
          python notification_sender.py 2>&1 | tee notifications.log
        env:
          FIREBASE_PROJECT_ID: livel-analytics
          FIREBASE_SERVER_KEY: ${{ secrets.FIREBASE_SERVER_KEY }}
        continue-on-error: true
        
      - name: Verificar falhas na execuÃ§Ã£o
        run: |
          if cat output.log | grep -q "Falha no scraper\|Falha no reporter\|ERRO FATAL"; then
            echo "::warning::Falhas detectadas na execuÃ§Ã£o!"
            grep -A 10 "Falha\|ERRO" output.log || true
            echo "SCRAPING_FALHOU=true" >> $GITHUB_ENV
          else
            echo "Nenhuma falha detectada na execuÃ§Ã£o."
            echo "SCRAPING_FALHOU=false" >> $GITHUB_ENV
          fi
      
      # CRIAR ISSUE AUTOMÃTICA SE FALHOU
      - name: Criar issue se scraper falhou
        if: env.SCRAPING_FALHOU == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš¨ Scraper falhou em ${new Date().toLocaleString('pt-BR')}`;
            const body = `
            ## âŒ Falha no Scraper Livelo
            
            **â° HorÃ¡rio:** ${new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'})}
            **ğŸ”— Logs:** [Ver detalhes](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### PossÃ­veis causas:
            - [ ] Site mudou estrutura HTML
            - [ ] Elementos foram alterados  
            - [ ] Timeout de conexÃ£o
            - [ ] Erro no processamento dos dados
            
            ### âš ï¸ AÃ§Ã£o necessÃ¡ria:
            1. Verificar logs do workflow
            2. Testar scraper localmente
            3. Ajustar seletores se necessÃ¡rio
            4. Fechar esta issue apÃ³s correÃ§Ã£o
            `;
            
            // Verificar se jÃ¡ existe issue aberta
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraper-failure'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scraper-failure', 'urgent']
              });
            }
      
      - name: Listar arquivos de diagnÃ³stico
        run: |
          echo "ğŸ“ Arquivos HTML gerados:"
          ls -la *.html 2>/dev/null || echo "Nenhum arquivo HTML encontrado"
          
          echo "ğŸ“ Arquivos de log gerados:"
          ls -la *.log 2>/dev/null || echo "Nenhum arquivo de log encontrado"
          
          echo "ğŸ“ Screenshots gerados:"
          ls -la *.png 2>/dev/null || echo "Nenhum screenshot encontrado"
          
          echo "ğŸ“ Arquivos PWA/Firebase:"
          ls -la sw.js manifest.json firebase-config-runtime.js 2>/dev/null || echo "Arquivos PWA nÃ£o encontrados"
          
          echo "ğŸ“ Arquivos de dados:"
          ls -la *.xlsx *.json 2>/dev/null || echo "Arquivos de dados nÃ£o encontrados"
      
      - name: Configurar Git para commit
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
      - name: Commit e push dos novos dados
        run: |
          timestamp=$(date +%Y%m%d_%H%M%S)
          
          # Copiar logs com timestamp
          if [ -f "output.log" ]; then
            cp output.log "logs/scraper_${timestamp}.log"
          fi
          
          if [ -f "notifications.log" ]; then
            cp notifications.log "logs/notifications_${timestamp}.log"
          fi
          
          if [ -f "validation.log" ]; then
            cp validation.log "logs/validation_${timestamp}.log"
          fi
          
          # Adicionar arquivos principais
          git add -f *.html *.xlsx *.json sw.js manifest.json firebase-config-runtime.js 2>/dev/null || true
          
          # Adicionar logs
          git add logs/ relatorios/ 2>/dev/null || true
          
          # Adicionar arquivos de debug
          git add -f debug_*.* *.log 2>/dev/null || true
          
          # Verificar se hÃ¡ algo para comitar
          if git diff --staged --quiet; then
            echo "âœ… Nenhuma mudanÃ§a para comitar"
          else
            commit_message="ğŸ“Š AtualizaÃ§Ã£o automÃ¡tica Livelo Analytics [$(date +'%d/%m/%Y %H:%M')]
            
            ğŸ”§ Firebase: ${{ steps.check_firebase.outputs.FIREBASE_OK == 'true' && 'Configurado' || 'Com problemas' }}
            ğŸ“ˆ Scraping: ${{ env.SCRAPING_FALHOU == 'true' && 'Falhou' || 'Sucesso' }}
            â° Timestamp: ${timestamp}"
            
            git commit -m "$commit_message"
            
            # Push com retry
            for i in {1..3}; do
              if git push; then
                echo "âœ… Push realizado com sucesso (tentativa $i)"
                break
              else
                echo "âš ï¸ Falha no push (tentativa $i), tentando novamente..."
                sleep 5
              fi
            done
          fi
      
      # ============ GITHUB PAGES DEPLOY ============
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configurar diretÃ³rio de publicaÃ§Ã£o
        run: |
          mkdir -p ./public
          
          echo "ğŸ“ Copiando arquivos para o diretÃ³rio public..."
          
          # Copiar HTML principal
          if [ -f "relatorio_livelo.html" ]; then
            cp relatorio_livelo.html ./public/index.html
            echo "âœ… HTML principal copiado"
          else
            echo "âŒ relatorio_livelo.html nÃ£o encontrado - criando pÃ¡gina de erro"
            cat > ./public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <title>Livelo Analytics - Em ManutenÃ§Ã£o</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
          </head>
          <body>
            <h1>ğŸ”§ Sistema em ManutenÃ§Ã£o</h1>
            <p>O dashboard estÃ¡ sendo atualizado. Tente novamente em alguns minutos.</p>
          </body>
          </html>
          EOF
          fi
          
          # Copiar arquivos PWA
          for file in manifest.json sw.js firebase-config-runtime.js; do
            if [ -f "$file" ]; then
              cp "$file" ./public/
              echo "âœ… $file copiado"
            else
              echo "âš ï¸ $file nÃ£o encontrado"
            fi
          done
          
          # Copiar outros arquivos Ãºteis
          cp -f *.xlsx ./public/ 2>/dev/null || echo "ğŸ“Š Nenhum arquivo Excel para copiar"
          
          echo "ğŸ“‚ ConteÃºdo do diretÃ³rio public:"
          ls -la ./public/
          
      - name: Setup Pages
        uses: actions/configure-pages@v3
        
      - name: Deploy para GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          clean: true

      # ============ FIREBASE HOSTING (OPCIONAL) ============
      
      - name: Deploy Firebase Hosting (se configurado)
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' }}
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: livel-analytics
          entryPoint: .
        continue-on-error: true

      # ============ RESUMO FINAL ============
      
      - name: Resumo da execuÃ§Ã£o
        run: |
          echo "
          ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO LIVELO ANALYTICS
          ========================================
          â° HorÃ¡rio: $(date +'%d/%m/%Y %H:%M:%S %Z')
          ğŸ“ Arquivos no public: $(ls -1 ./public/ 2>/dev/null | wc -l) arquivos
          
          ğŸ” STATUS DOS COMPONENTES:
          âœ… Scraping: ${{ env.SCRAPING_FALHOU == 'true' && 'âŒ FALHOU' || 'âœ… SUCESSO' }}
          ğŸŒ GitHub Pages: âœ… Deployado
          ğŸ”¥ Firebase Messaging: ${{ steps.check_firebase.outputs.FIREBASE_OK == 'true' && 'âœ… Ativo' || 'âš ï¸ Com problemas' }}
          ğŸ  Firebase Hosting: ${{ secrets.FIREBASE_SERVICE_ACCOUNT != '' && 'âœ… Configurado' || 'âš ï¸ NÃ£o configurado' }}
          ğŸ”” NotificaÃ§Ãµes: ${{ steps.check_firebase.outputs.FIREBASE_OK == 'true' && 'âœ… Processadas' || 'âš ï¸ Puladas' }}
          
          ğŸŒ ACESSO:
          ğŸ“– GitHub Pages: https://gcaressato.github.io/livelo_scraper/
          ğŸ”¥ Firebase Hosting: https://livel-analytics.web.app/ (se configurado)
          "
          
          if [ "${{ env.SCRAPING_FALHOU }}" = "true" ]; then
            echo "::warning::âš ï¸ Scraper falhou mas deploy foi mantido com dados existentes"
          else
            echo "::notice::ğŸ‰ Deploy concluÃ­do com sucesso!"
          fi
