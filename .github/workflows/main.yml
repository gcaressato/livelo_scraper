name: Livelo Analytics | Firebase Integrado
on:
  schedule:
    - cron: '0 10 * * *'  # 7h Brasil = 10h UTC
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # JOB 1: PIPELINE PRINCIPAL (Scraping + AnÃ¡lise + GitHub Pages)
  pipeline_principal:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    outputs:
      pipeline_success: ${{ steps.validation.outputs.success }}
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar dependÃªncias principais
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy requests
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Criar diretÃ³rios necessÃ¡rios
        run: |
          mkdir -p logs
          mkdir -p public
          
      - name: Executar pipeline principal (main.py)
        run: |
          echo "ğŸš€ Iniciando pipeline Livelo Analytics..."
          python main.py 2>&1 | tee pipeline.log
          echo "PIPELINE_STATUS=$?" >> $GITHUB_ENV
        continue-on-error: true
          
      - name: ValidaÃ§Ã£o rigorosa dos resultados
        id: validation
        run: |
          echo "ğŸ“Š Validando resultados do pipeline..."
          
          if [ "$PIPELINE_STATUS" = "0" ]; then
            echo "âœ… Pipeline executado com sucesso"
            echo "PIPELINE_OK=true" >> $GITHUB_ENV
          else
            echo "âŒ Pipeline falhou - saindo imediatamente"
            echo "PIPELINE_OK=false" >> $GITHUB_ENV
            exit 1
          fi
          
          # Verificar arquivos crÃ­ticos
          if [ -f "public/index.html" ] && [ -f "livelo_parceiros.xlsx" ]; then
            echo "âœ… Arquivos principais encontrados"
            ls -la public/index.html *.xlsx
            echo "FILES_OK=true" >> $GITHUB_ENV
          else
            echo "âŒ Arquivos principais ausentes"
            echo "FILES_OK=false" >> $GITHUB_ENV
            exit 1
          fi
          
          # Verificar tamanho do HTML
          if [ -f "public/index.html" ]; then
            size=$(stat -f%z "public/index.html" 2>/dev/null || stat -c%s "public/index.html" 2>/dev/null || echo "0")
            if [ "$size" -gt 50000 ]; then
              echo "âœ… HTML vÃ¡lido: $size bytes"
              echo "success=true" >> $GITHUB_OUTPUT
            else
              echo "âŒ HTML muito pequeno: $size bytes"
              echo "success=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        
      - name: Upload pÃ¡ginas como artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public
          
      - name: Configurar Git e fazer commit
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
          timestamp=$(date +"%d/%m/%Y %H:%M")
          
          git add -f public/index.html
          git add -f livelo_parceiros.xlsx
          git add -f *.log 2>/dev/null || true
          
          if git diff --staged --quiet; then
            echo "â„¹ï¸ Nenhuma mudanÃ§a detectada para commit"
          else
            echo "ğŸ“ Fazendo commit das mudanÃ§as..."
            
            git commit -m "ğŸ“Š AtualizaÃ§Ã£o Livelo Analytics - $timestamp

            âœ… Pipeline: Sucesso com validaÃ§Ã£o rigorosa
            ğŸ“„ Arquivos: Validados (min 50 parceiros)
            ğŸ“ Preparado para GitHub Pages
            ğŸ”¥ Firebase: SerÃ¡ processado no prÃ³ximo job
            â° Executado: $timestamp"
            
            # Push com retry
            for i in {1..3}; do
              if git push; then
                echo "âœ… Push realizado com sucesso (tentativa $i)"
                break
              else
                echo "âš ï¸ Falha no push (tentativa $i)"
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "âŒ Push falhou apÃ³s 3 tentativas"
                  exit 1
                fi
              fi
            done
          fi

  # JOB 2: DEPLOY GITHUB PAGES
  deploy_github_pages:
    needs: pipeline_principal
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: needs.pipeline_principal.outputs.pipeline_success == 'true'
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
      
    steps:
      - name: Deploy para GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # JOB 3: FIREBASE INTEGRATION
  firebase_integration:
    needs: [pipeline_principal, deploy_github_pages]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always() && needs.pipeline_principal.outputs.pipeline_success == 'true'
    
    steps:
      - name: Checkout para Firebase
        uses: actions/checkout@v4
        
      - name: Setup Node.js para Firebase
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          # REMOVIDO: cache: 'npm'
          
      - name: Setup Python para notificaÃ§Ãµes
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Instalar dependÃªncias Firebase
        run: |
          # Verificar se package.json existe antes de instalar
          if [ -f "package.json" ]; then
            echo "ğŸ“¦ Instalando dependÃªncias do package.json..."
            npm install
          else
            echo "ğŸ“¦ package.json nÃ£o encontrado, criando dependÃªncias mÃ­nimas..."
            npm init -y
            npm install firebase@^9.0.0
          fi
          
          # Instalar Firebase CLI globalmente
          npm install -g firebase-tools
          
          # Instalar dependÃªncias Python
          pip install firebase-admin pandas openpyxl
          
      - name: Verificar configuraÃ§Ã£o Firebase
        run: |
          echo "ğŸ” Verificando configuraÃ§Ã£o Firebase..."
          
          if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
            echo "âœ… FIREBASE_PROJECT_ID configurado"
            echo "FIREBASE_CONFIGURED=true" >> $GITHUB_ENV
          else
            echo "â„¹ï¸ FIREBASE_PROJECT_ID nÃ£o configurado"
            echo "FIREBASE_CONFIGURED=false" >> $GITHUB_ENV
          fi
          
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "âœ… FIREBASE_SERVICE_ACCOUNT configurado"
          else
            echo "â„¹ï¸ FIREBASE_SERVICE_ACCOUNT nÃ£o configurado"
            echo "FIREBASE_CONFIGURED=false" >> $GITHUB_ENV
          fi
          
          if [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "âœ… FIREBASE_TOKEN configurado"
          else
            echo "â„¹ï¸ FIREBASE_TOKEN nÃ£o configurado"
          fi
          
      - name: Criar estrutura Firebase mÃ­nima
        if: env.FIREBASE_CONFIGURED == 'true'
        run: |
          echo "ğŸ”§ Criando estrutura Firebase..."
          
          # Criar firebase.json se nÃ£o existir
          if [ ! -f "firebase.json" ]; then
            echo "ğŸ“ Criando firebase.json..."
            cat > firebase.json << 'EOF'
          {
            "hosting": {
              "public": "public",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**"
              ],
              "rewrites": [
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ]
            }
          }
          EOF
          fi
          
          # Criar diretÃ³rio public
          mkdir -p public
          
          # Criar .firebaserc se nÃ£o existir
          if [ ! -f ".firebaserc" ]; then
            echo "ğŸ“ Criando .firebaserc..."
            cat > .firebaserc << EOF
          {
            "projects": {
              "default": "${{ secrets.FIREBASE_PROJECT_ID }}"
            }
          }
          EOF
          fi
          
      - name: Criar configuraÃ§Ã£o Firebase dinÃ¢mica
        if: env.FIREBASE_CONFIGURED == 'true'
        run: |
          echo "ğŸ”§ Criando configuraÃ§Ã£o Firebase dinÃ¢mica..."
          
          # Criar pasta sender se nÃ£o existir
          mkdir -p sender
          
          # Criar firebase-config.js com valores reais
          cat > sender/firebase-config.js << 'EOF'
          import { initializeApp } from 'firebase/app';
          import { getMessaging } from 'firebase/messaging';
          import { getFirestore } from 'firebase/firestore';

          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };

          const app = initializeApp(firebaseConfig);
          const messaging = getMessaging(app);
          const db = getFirestore(app);

          export { messaging, db };
          EOF
          
          # Criar Service Worker com valores reais
          cat > public/firebase-messaging-sw.js << 'EOF'
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

          const firebaseConfig = {
            apiKey: "${{ secrets.FIREBASE_API_KEY }}",
            authDomain: "${{ secrets.FIREBASE_AUTH_DOMAIN }}",
            projectId: "${{ secrets.FIREBASE_PROJECT_ID }}",
            storageBucket: "${{ secrets.FIREBASE_STORAGE_BUCKET }}",
            messagingSenderId: "${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}",
            appId: "${{ secrets.FIREBASE_APP_ID }}",
            measurementId: "${{ secrets.FIREBASE_MEASUREMENT_ID }}"
          };

          firebase.initializeApp(firebaseConfig);
          const messaging = firebase.messaging();

          messaging.onBackgroundMessage((payload) => {
            const notificationTitle = payload.notification?.title || 'Livelo Analytics';
            const notificationOptions = {
              body: payload.notification?.body || 'Novas atualizaÃ§Ãµes disponÃ­veis',
              icon: '/icon-192.png',
              tag: 'livelo-update'
            };
            self.registration.showNotification(notificationTitle, notificationOptions);
          });

          self.addEventListener('notificationclick', (event) => {
            event.notification.close();
            if (event.action === 'view') {
              event.waitUntil(clients.openWindow('https://gcaressato.github.io/livelo_scraper/'));
            }
          });
          EOF
          
          echo "âœ… ConfiguraÃ§Ã£o Firebase dinÃ¢mica criada"
          
      - name: Sincronizar arquivos do pipeline
        run: |
          echo "ğŸ“¥ Sincronizando arquivos do pipeline..."
          
          # Pull das mudanÃ§as do job anterior
          git pull origin main || echo "Nenhuma mudanÃ§a para sincronizar"
          
          if [ -f "public/index.html" ] && [ -f "livelo_parceiros.xlsx" ]; then
            echo "âœ… Arquivos encontrados"
            ls -la public/index.html *.xlsx
          else
            echo "âŒ Arquivos nÃ£o encontrados apÃ³s sincronizaÃ§Ã£o"
            echo "ğŸ“ Arquivos disponÃ­veis:"
            ls -la
            exit 1
          fi
          
      - name: Deploy Firebase Hosting
        if: env.FIREBASE_CONFIGURED == 'true'
        run: |
          echo "ğŸš€ Fazendo deploy Firebase..."
          
          # Usar token Firebase CLI se disponÃ­vel
          if [ -n "${{ secrets.FIREBASE_TOKEN }}" ]; then
            echo "ğŸ”‘ Usando FIREBASE_TOKEN"
            firebase deploy --only hosting --token "${{ secrets.FIREBASE_TOKEN }}" --project "${{ secrets.FIREBASE_PROJECT_ID }}" --non-interactive
          else
            echo "âš ï¸ FIREBASE_TOKEN nÃ£o encontrado"
            echo "â„¹ï¸ Configure FIREBASE_TOKEN nos secrets para deploy automÃ¡tico"
            exit 0
          fi
          
          echo "âœ… Deploy Firebase concluÃ­do"
          echo "ğŸŒ URL: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/"
        continue-on-error: true
        
      - name: Executar notificaÃ§Ãµes
        if: env.FIREBASE_CONFIGURED == 'true'
        run: |
          echo "ğŸ“± Executando notificaÃ§Ãµes..."
          
          if [ -f "notification_sender.py" ]; then
            timeout 300 python notification_sender.py || echo "NotificaÃ§Ãµes concluÃ­das"
          else
            echo "notification_sender.py nÃ£o encontrado"
          fi
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_VAPID_KEY: ${{ secrets.FIREBASE_VAPID_KEY }}
        continue-on-error: true
        
      - name: Limpar arquivos temporÃ¡rios
        if: always()
        run: |
          rm -f firebase-service-account.json 2>/dev/null || true
          rm -f firebase_config_inject.js 2>/dev/null || true
          echo "ğŸ§¹ Arquivos temporÃ¡rios removidos"

  # JOB 4: RESUMO FINAL
  summary:
    needs: [pipeline_principal, deploy_github_pages, firebase_integration]
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always()
    
    steps:
      - name: Resumo final da execuÃ§Ã£o
        run: |
          echo ""
          echo "ğŸ‰ RESUMO DA EXECUÃ‡ÃƒO LIVELO ANALYTICS"
          echo "====================================="
          echo "â° ConcluÃ­do: $(date +'%d/%m/%Y %H:%M:%S')"
          echo ""
          echo "ğŸ“Š STATUS DOS JOBS:"
          echo "â”œâ”€ Pipeline Principal: ${{ needs.pipeline_principal.result == 'success' && 'âœ… SUCESSO' || 'âŒ FALHOU' }}"
          echo "â”œâ”€ GitHub Pages: ${{ needs.deploy_github_pages.result == 'success' && 'âœ… SUCESSO' || 'âŒ FALHOU' }}"
          echo "â””â”€ Firebase: ${{ needs.firebase_integration.result == 'success' && 'âœ… SUCESSO' || 'âšª OPCIONAL' }}"
          echo ""
          
          if [ "${{ needs.pipeline_principal.result }}" = "success" ]; then
            echo "ğŸŒ SISTEMA ONLINE:"
            echo "â”œâ”€ GitHub Pages: https://gcaressato.github.io/livelo_scraper/"
            
            if [ "${{ needs.firebase_integration.result }}" = "success" ]; then
              echo "â”œâ”€ Firebase Hosting: https://${{ secrets.FIREBASE_PROJECT_ID }}.web.app/"
              echo "â””â”€ NotificaÃ§Ãµes Push: âœ… Ativas"
            else
              echo "â””â”€ Firebase: âšª NÃ£o configurado (opcional)"
            fi
            
            echo ""
            echo "ğŸ¯ FUNCIONALIDADES ATIVAS:"
            echo "â”œâ”€ âœ… Scraping automÃ¡tico"
            echo "â”œâ”€ âœ… AnÃ¡lises e relatÃ³rios"
            echo "â”œâ”€ âœ… Sistema de favoritos"
            echo "â”œâ”€ âœ… Deploy automÃ¡tico"
            
            if [ "${{ needs.firebase_integration.result }}" = "success" ]; then
              echo "â””â”€ âœ… NotificaÃ§Ãµes push"
            else
              echo "â””â”€ âšª NotificaÃ§Ãµes push (desabilitadas)"
            fi
            
            echo ""
            echo "âœ… SISTEMA FUNCIONANDO NORMALMENTE!"
            echo "::notice::Livelo Analytics online - Todos os dados atualizados"
          else
            echo "âŒ FALHA NO PIPELINE PRINCIPAL!"
            echo ""
            echo "ğŸš¨ AÃ‡Ã•ES NECESSÃRIAS:"
            echo "â”œâ”€ Verificar logs detalhados do job 'pipeline_principal'"
            echo "â”œâ”€ Analisar possÃ­veis mudanÃ§as no site da Livelo"
            echo "â”œâ”€ Verificar conectividade e dependÃªncias"
            echo "â””â”€ Corrigir problemas antes da prÃ³xima execuÃ§Ã£o"
            echo ""
            echo "::error::Sistema principal falhou - Verificar logs para diagnÃ³stico"
          fi
