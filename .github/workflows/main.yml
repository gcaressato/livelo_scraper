name: Livelo Partners Scraper
on:
  schedule:
    - cron: '0 12 * * *'  # Executa todos os dias Ã s 12:00 UTC
  workflow_dispatch:  # Permite execuÃ§Ã£o manual

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do repositÃ³rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar dependÃªncias
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy
          # Verificar versÃ£o do Selenium e Chrome
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Verificar ambiente
        run: |
          echo "DiretÃ³rio atual: $(pwd)"
          echo "ConteÃºdo do diretÃ³rio: $(ls -la)"
          
      - name: Criar diretÃ³rios para logs e saÃ­da
        run: |
          mkdir -p logs
          mkdir -p relatorios
          
      - name: Executar scraper diretamente (para depuraÃ§Ã£o)
        run: |
          python livelo_scraper.py 2>&1 | tee scraper_debug.log
        continue-on-error: true
          
      - name: Executar script principal
        run: |
          python main.py 2>&1 | tee output.log
        continue-on-error: true
        
      # VALIDAÃ‡ÃƒO INTELIGENTE DE DADOS
      - name: Validar qualidade dos dados
        id: validate
        run: |
          python -c "
          import pandas as pd
          from datetime import datetime, timedelta
          import os
          
          success = True
          
          try:
              # Verificar se arquivo Excel existe
              if not os.path.exists('livelo_parceiros.xlsx'):
                  print('âŒ Arquivo Excel nÃ£o encontrado!')
                  success = False
              else:
                  df = pd.read_excel('livelo_parceiros.xlsx')
                  
                  # Verificar se dados sÃ£o recentes (Ãºltimas 24h)
                  df['Timestamp'] = pd.to_datetime(df['Timestamp'])
                  latest_date = df['Timestamp'].max()
                  now = datetime.now()
                  
                  if (now - latest_date).total_seconds() > 86400:  # 24 horas
                      print(f'âš ï¸ Dados podem estar antigos! Ãšltimo: {latest_date}')
                  
                  # Verificar quantidade mÃ­nima
                  if len(df) < 30:
                      print(f'âš ï¸ Poucos dados coletados: {len(df)} registros')
                  else:
                      print(f'âœ… Dados validados: {len(df)} registros, Ãºltimo em {latest_date}')
              
              # Verificar se HTML foi gerado
              if not os.path.exists('relatorio_livelo.html'):
                  print('âŒ HTML nÃ£o foi gerado!')
                  success = False
              else:
                  print('âœ… HTML gerado com sucesso')
              
              if success:
                  print('VALIDATION_SUCCESS=true')
              else:
                  print('VALIDATION_FAILED=true')
                  
          except Exception as e:
              print(f'âŒ Erro na validaÃ§Ã£o: {e}')
              print('VALIDATION_ERROR=true')
          " 2>&1 | tee validation.log
        continue-on-error: true
        
      - name: Verificar falhas na execuÃ§Ã£o
        run: |
          if cat output.log | grep -q "Falha no scraper\|Falha no reporter\|ERRO FATAL"; then
            echo "::warning::Falhas detectadas na execuÃ§Ã£o!"
            grep -A 10 "Falha\|ERRO" output.log || true
            echo "SCRAPING_FALHOU=true" >> $GITHUB_ENV
          else
            echo "Nenhuma falha detectada na execuÃ§Ã£o."
            echo "SCRAPING_FALHOU=false" >> $GITHUB_ENV
          fi
      
      # CRIAR ISSUE AUTOMÃTICA SE FALHOU
      - name: Criar issue se scraper falhou
        if: env.SCRAPING_FALHOU == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const title = `ğŸš¨ Scraper falhou em ${new Date().toLocaleString('pt-BR')}`;
            const body = `
            ## âŒ Falha no Scraper Livelo
            
            **â° HorÃ¡rio:** ${new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'})}
            **ğŸ”— Logs:** [Ver detalhes](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### PossÃ­veis causas:
            - [ ] Site mudou estrutura HTML
            - [ ] Elementos foram alterados  
            - [ ] Timeout de conexÃ£o
            - [ ] Erro no processamento dos dados
            
            ### âš ï¸ AÃ§Ã£o necessÃ¡ria:
            1. Verificar logs do workflow
            2. Testar scraper localmente
            3. Ajustar seletores se necessÃ¡rio
            4. Fechar esta issue apÃ³s correÃ§Ã£o
            
            ---
            *Issue criada automaticamente pelo GitHub Actions*
            `;
            
            // Verificar se jÃ¡ existe issue aberta
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraper-failure'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scraper-failure', 'urgent']
              });
              
              console.log('ğŸ“§ Issue criada - vocÃª receberÃ¡ email do GitHub automaticamente!');
            } else {
              console.log('Issue de falha jÃ¡ existe, nÃ£o criando duplicata');
            }
      
      - name: Listar arquivos de diagnÃ³stico
        run: |
          echo "Arquivos HTML gerados:"
          ls -la *.html || echo "Nenhum arquivo HTML encontrado"
          echo "Arquivos de log gerados:"
          ls -la *.log || echo "Nenhum arquivo de log encontrado"
          echo "Screenshots gerados:"
          ls -la *.png || echo "Nenhum screenshot encontrado"
      
      - name: Configurar Git para commit
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
      - name: Commit e push dos novos dados
        run: |
          # Copiar logs
          if [ -f "output.log" ]; then
            cp output.log logs/scraper_$(date +%Y%m%d_%H%M%S).log
          fi
          
          # Adicionar arquivos de diagnÃ³stico individualmente para evitar problemas
          for file in debug_*.html debug_*.png debug_*.txt *.log; do
            if [ -f "$file" ]; then
              git add -f "$file" || echo "NÃ£o foi possÃ­vel adicionar $file"
            fi
          done
          
          # Adicionar diretÃ³rios
          if [ -d "logs" ]; then
            git add logs/ || echo "NÃ£o foi possÃ­vel adicionar logs/"
          fi
          
          if [ -d "relatorios" ]; then
            git add relatorios/ || echo "NÃ£o foi possÃ­vel adicionar relatorios/"
          fi
          
          # Adicionar o arquivo Excel se existir
          if [ -f "livelo_parceiros.xlsx" ]; then
            git add livelo_parceiros.xlsx || echo "NÃ£o foi possÃ­vel adicionar livelo_parceiros.xlsx"
          fi
          
          # Adicionar o relatÃ³rio HTML se existir
          if [ -f "relatorio_livelo.html" ]; then
            git add relatorio_livelo.html || echo "NÃ£o foi possÃ­vel adicionar relatorio_livelo.html"
          fi
          
          # Tentar commit com verificaÃ§Ã£o se hÃ¡ algo para comitar
          git diff --staged --quiet || git commit -m "AtualizaÃ§Ã£o automÃ¡tica [$(date)]"
          
          # Push com tratamento de erro
          git push || echo "Falha ao fazer push, verifique os logs para mais detalhes"
      
      # ============ SEÃ‡ÃƒO PWA + FIREBASE ============
      
      - name: Setup Node.js para Firebase
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Criar arquivos PWA
        run: |
          # Criar manifest.json
          cat > manifest.json << 'EOF'
          {
            "name": "Livelo Analytics Pro",
            "short_name": "Livelo",
            "description": "Dashboard analÃ­tico para ofertas Livelo",
            "start_url": "/",
            "display": "standalone",
            "background_color": "#151f4f",
            "theme_color": "#ff0a8c",
            "orientation": "portrait-primary",
            "icons": [
              {
                "src": "https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L",
                "sizes": "192x192",
                "type": "image/png"
              },
              {
                "src": "https://via.placeholder.com/512x512/ff0a8c/ffffff?text=L", 
                "sizes": "512x512",
                "type": "image/png"
              }
            ]
          }
          EOF
          
          # Criar service worker bÃ¡sico
          cat > sw.js << 'EOF'
          const CACHE_NAME = 'livelo-analytics-v1';
          const urlsToCache = [
            '/',
            '/index.html',
            '/manifest.json'
          ];
          
          self.addEventListener('install', (event) => {
            event.waitUntil(
              caches.open(CACHE_NAME)
                .then((cache) => cache.addAll(urlsToCache))
            );
          });
          
          self.addEventListener('fetch', (event) => {
            event.respondWith(
              caches.match(event.request)
                .then((response) => {
                  return response || fetch(event.request);
                })
            );
          });
          EOF
          
          # Criar firebase-messaging-sw.js APENAS com secrets
          cat > firebase-messaging-sw.js << EOF
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');

          // Verificar se secrets estÃ£o disponÃ­veis
          const senderId = "${{ secrets.FIREBASE_SENDER_ID }}";
          const projectId = "${{ secrets.FIREBASE_PROJECT_ID }}";
          
          if (!senderId || senderId.includes('secrets.') || !projectId || projectId.includes('secrets.')) {
            console.error('ğŸ”’ Service Worker: Secrets Firebase nÃ£o configurados');
          } else {
            try {
              // ConfiguraÃ§Ã£o Firebase para Service Worker
              const firebaseConfig = {
                apiKey: "AIzaSyAibNVfTL0kvG_R3rKYYSnAeQWc5oVBFYk",
                authDomain: projectId + ".firebaseapp.com",
                projectId: projectId,
                storageBucket: projectId + ".firebasestorage.app",
                messagingSenderId: senderId,
                appId: "1:" + senderId + ":web:59b4c1df4fc553410c6f4b"
              };

              firebase.initializeApp(firebaseConfig);
              const messaging = firebase.messaging();

              messaging.onBackgroundMessage((payload) => {
                console.log('ğŸ“¨ Background Message:', payload);
                
                const notificationTitle = payload.notification?.title || 'ğŸ¯ Livelo Analytics';
                const notificationOptions = {
                  body: payload.notification?.body || 'Nova atualizaÃ§Ã£o disponÃ­vel!',
                  icon: 'https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L',
                  badge: 'https://via.placeholder.com/96x96/ff0a8c/ffffff?text=L',
                  tag: 'livelo-offer',
                  requireInteraction: true,
                  actions: [
                    {
                      action: 'open',
                      title: 'Ver Dashboard'
                    }
                  ]
                };

                self.registration.showNotification(notificationTitle, notificationOptions);
              });
              
              console.log('âœ… Service Worker Firebase inicializado');
            } catch (error) {
              console.error('âŒ Erro no Service Worker Firebase:', error);
            }
          }

          self.addEventListener('notificationclick', (event) => {
            event.notification.close();
            if (event.action === 'open' || !event.action) {
              clients.openWindow('/');
            }
          });
          EOF
          
          # Criar firebase.json
          cat > firebase.json << 'EOF'
          {
            "hosting": {
              "public": "./public",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**"
              ],
              "rewrites": [
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ],
              "headers": [
                {
                  "source": "/firebase-messaging-sw.js",
                  "headers": [
                    {
                      "key": "Service-Worker-Allowed",
                      "value": "/"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          
          echo "âœ… Arquivos PWA criados com sucesso!"
      
      # CONFIGURAR E PROCESSAR HTML COM PLACEHOLDERS
      - name: Configurar diretÃ³rio de publicaÃ§Ã£o
        run: |
          mkdir -p ./public
          
          # NOVO: Substituir placeholders no HTML
          if [ -f "relatorio_livelo.html" ]; then
            echo "ğŸ“ Processando placeholders no HTML..."
            
            # Verificar se os secrets estÃ£o disponÃ­veis
            if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
              echo "âœ… FIREBASE_PROJECT_ID disponÃ­vel"
              PROJECT_ID="${{ secrets.FIREBASE_PROJECT_ID }}"
            else
              echo "âŒ FIREBASE_PROJECT_ID nÃ£o configurado"
              PROJECT_ID="{{FIREBASE_PROJECT_ID}}"
            fi
            
            if [ -n "${{ secrets.FIREBASE_SENDER_ID }}" ]; then
              echo "âœ… FIREBASE_SENDER_ID disponÃ­vel"
              SENDER_ID="${{ secrets.FIREBASE_SENDER_ID }}"
            else
              echo "âŒ FIREBASE_SENDER_ID nÃ£o configurado - notificaÃ§Ãµes nÃ£o funcionarÃ£o"
              SENDER_ID="{{FIREBASE_SENDER_ID}}"
            fi
            
            if [ -n "${{ secrets.FIREBASE_VAPID_KEY }}" ]; then
              echo "âœ… FIREBASE_VAPID_KEY disponÃ­vel"
              VAPID_KEY="${{ secrets.FIREBASE_VAPID_KEY }}"
            else
              echo "âŒ FIREBASE_VAPID_KEY nÃ£o configurado - notificaÃ§Ãµes nÃ£o funcionarÃ£o"
              VAPID_KEY="{{FIREBASE_VAPID_KEY}}"
            fi
            
            # Fazer backup do original
            cp relatorio_livelo.html relatorio_livelo_backup.html
            
            # Substituir placeholders com escape adequado
            sed -i "s|{{FIREBASE_PROJECT_ID}}|${PROJECT_ID}|g" relatorio_livelo.html
            sed -i "s|{{FIREBASE_SENDER_ID}}|${SENDER_ID}|g" relatorio_livelo.html
            sed -i "s|{{FIREBASE_VAPID_KEY}}|${VAPID_KEY}|g" relatorio_livelo.html
            
            # Verificar se substituiÃ§Ã£o funcionou
            if grep -q "{{FIREBASE_" relatorio_livelo.html; then
              echo "âŒ Alguns placeholders nÃ£o foram substituÃ­dos!"
              grep "{{FIREBASE_" relatorio_livelo.html || true
            else
              echo "âœ… Todos os placeholders foram substituÃ­dos"
            fi
            
            # Copiar HTML processado
            cp relatorio_livelo.html ./public/index.html
            echo "âœ… HTML processado e copiado"
          else
            echo "âŒ relatorio_livelo.html nÃ£o encontrado"
            # Criar HTML de emergÃªncia
            cat > ./public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Livelo Analytics - Em ManutenÃ§Ã£o</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <link rel="manifest" href="manifest.json">
            <meta name="theme-color" content="#ff0a8c">
            <style>
              body { font-family: Arial; text-align: center; padding: 50px; background: #f8f9fa; }
              .container { max-width: 600px; margin: 0 auto; }
              .error { color: #dc3545; }
              .info { color: #6c757d; margin-top: 20px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸš§ Livelo Analytics</h1>
              <p class="error">Dashboard temporariamente indisponÃ­vel</p>
              <p class="info">O sistema estÃ¡ em manutenÃ§Ã£o. Tente novamente em alguns minutos.</p>
              <p class="info"><small>Ãšltima tentativa: $(date)</small></p>
            </div>
          </body>
          </html>
          EOF
          fi
          
          # Copiar arquivos PWA
          cp manifest.json ./public/
          cp sw.js ./public/
          cp firebase-messaging-sw.js ./public/
          
          # Copiar outros arquivos necessÃ¡rios
          cp -r *.css *.js ./public/ 2>/dev/null || echo "Nenhum arquivo CSS/JS adicional encontrado"
          if [ -d "relatorios" ]; then
            cp -r relatorios/* ./public/ 2>/dev/null || echo "Nenhum arquivo encontrado em relatÃ³rios"
          fi
          
          echo "Arquivos no diretÃ³rio public:"
          ls -la ./public/
          
      - name: Setup Pages
        uses: actions/configure-pages@v3
        
      - name: Deploy para GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          clean: true
      
      # ============ DEPLOY FIREBASE (OPCIONAL) ============
      
      - name: Instalar Firebase CLI
        run: npm install -g firebase-tools
        continue-on-error: true
      
      - name: Deploy para Firebase Hosting
        if: env.SCRAPING_FALHOU == 'false'
        run: |
          # Verificar se temos as credenciais do Firebase
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "ğŸ”‘ Credenciais Firebase encontradas, fazendo deploy..."
            # Criar arquivo de credenciais
            echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-key.json
            export GOOGLE_APPLICATION_CREDENTIALS="firebase-key.json"
            
            # Fazer deploy
            firebase deploy --project "${{ secrets.FIREBASE_PROJECT_ID }}" --only hosting
            
            # Limpar credenciais
            rm -f firebase-key.json
          else
            echo "âš ï¸ Credenciais Firebase nÃ£o configuradas, pulando deploy"
          fi
        continue-on-error: true
      
      - name: Deploy de emergÃªncia no Firebase (dados antigos)
        if: env.SCRAPING_FALHOU == 'true'
        run: |
          # Deploy de emergÃªncia mesmo com falha para manter site no ar
          if [ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "âš ï¸ Fazendo deploy de emergÃªncia com dados antigos..."
            echo '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}' > firebase-key.json
            export GOOGLE_APPLICATION_CREDENTIALS="firebase-key.json"
            
            firebase deploy --project "${{ secrets.FIREBASE_PROJECT_ID }}" --only hosting
            
            rm -f firebase-key.json
          else
            echo "âš ï¸ Credenciais Firebase nÃ£o configuradas para deploy de emergÃªncia"
          fi
        continue-on-error: true
      
      # ============ LOG FINAL ============
      
      - name: Resumo da execuÃ§Ã£o
        run: |
          echo "
          ğŸ“Š RESUMO DA EXECUÃ‡ÃƒO
          =====================
          â° HorÃ¡rio: $(date)
          ğŸ“ Arquivos gerados: $(ls -la ./public/ | wc -l) arquivos
          ğŸ” Status scraping: ${{ env.SCRAPING_FALHOU == 'true' && 'FALHOU' || 'SUCESSO' }}
          ğŸŒ GitHub Pages: âœ… Deployado
          ğŸ”¥ Firebase: ${{ env.SCRAPING_FALHOU == 'true' && 'âš ï¸ Deploy emergÃªncia' || 'âœ… Deploy normal' }}
          ğŸ“± PWA: âœ… Manifest + Service Workers criados
          ğŸ”” NotificaÃ§Ãµes: âœ… Firebase Messaging configurado
          
          ğŸ“§ NotificaÃ§Ãµes: ${{ env.SCRAPING_FALHOU == 'true' && 'Issue criada - email enviado' || 'Nenhuma necessÃ¡ria' }}
          "
          
          if [ "${{ env.SCRAPING_FALHOU }}" = "true" ]; then
            echo "::warning::Scraper falhou mas deploy foi mantido com dados antigos"
          else
            echo "::notice::ExecuÃ§Ã£o completada com sucesso!"
          fi
