name: Livelo Partners Scraper
on:
  schedule:
    - cron: '0 12 * * *'  # Executa todos os dias √†s 12:00 UTC
  workflow_dispatch:  # Permite execu√ß√£o manual

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar depend√™ncias
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy requests
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Criar diret√≥rios necess√°rios
        run: |
          mkdir -p logs
          mkdir -p relatorios
          mkdir -p public
          
      - name: Executar pipeline principal
        run: |
          echo "üöÄ Iniciando pipeline Livelo Analytics..."
          python main.py 2>&1 | tee pipeline.log
          echo "PIPELINE_STATUS=$?" >> $GITHUB_ENV
        continue-on-error: true
          
      - name: Verificar resultados do pipeline
        run: |
          echo "üìä Verificando resultados do pipeline..."
          
          if [ "$PIPELINE_STATUS" = "0" ]; then
            echo "‚úÖ Pipeline executado com sucesso"
            echo "PIPELINE_OK=true" >> $GITHUB_ENV
          else
            echo "‚ùå Pipeline com problemas"
            echo "PIPELINE_OK=false" >> $GITHUB_ENV
          fi
          
          # Verificar arquivos cr√≠ticos
          if [ -f "relatorio_livelo.html" ] && [ -f "livelo_parceiros.xlsx" ]; then
            echo "‚úÖ Arquivos principais encontrados"
            ls -la *.html *.xlsx
          else
            echo "‚ùå Arquivos principais ausentes"
            echo "FILES_OK=false" >> $GITHUB_ENV
          fi
          
          # Verificar tamanho dos arquivos
          if [ -f "relatorio_livelo.html" ]; then
            size=$(stat -f%z "relatorio_livelo.html" 2>/dev/null || stat -c%s "relatorio_livelo.html" 2>/dev/null || echo "0")
            if [ "$size" -gt 100000 ]; then
              echo "‚úÖ HTML v√°lido: $size bytes"
              echo "FILES_OK=true" >> $GITHUB_ENV
            else
              echo "‚ùå HTML muito pequeno: $size bytes"
              echo "FILES_OK=false" >> $GITHUB_ENV
            fi
          fi
        
      - name: Preparar arquivos para GitHub Pages
        if: env.FILES_OK == 'true'
        run: |
          echo "üìÅ Preparando arquivos para GitHub Pages..."
          
          # Copiar HTML principal como index.html
          cp relatorio_livelo.html public/index.html
          echo "‚úÖ HTML copiado para public/index.html"
          
          # Copiar dados Excel
          cp livelo_parceiros.xlsx public/
          echo "‚úÖ Excel copiado para public/"
          
          # Verificar arquivos no public
          echo "üìÇ Conte√∫do do diret√≥rio public:"
          ls -la public/
          
          # Verificar tamanhos
          echo "üìä Tamanhos dos arquivos:"
          du -h public/*
        
      - name: Configurar Git para commit
        if: env.FILES_OK == 'true'
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
      - name: Commit e push dos arquivos atualizados
        if: env.FILES_OK == 'true'
        run: |
          echo "üíæ Fazendo commit dos arquivos atualizados..."
          
          timestamp=$(date +"%d/%m/%Y %H:%M")
          
          # Adicionar arquivos principais
          git add -f relatorio_livelo.html livelo_parceiros.xlsx
          git add -f public/
          git add -f *.log 2>/dev/null || true
          
          # Verificar se h√° mudan√ßas para comitar
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è Nenhuma mudan√ßa detectada para commit"
          else
            echo "üìù Mudan√ßas detectadas, fazendo commit..."
            
            # Fazer commit
            git commit -m "üìä Atualiza√ß√£o Livelo Analytics - $timestamp

            üîß Pipeline: ${{ env.PIPELINE_OK == 'true' && 'Sucesso' || 'Com problemas' }}
            üìÑ Arquivos: ${{ env.FILES_OK == 'true' && 'V√°lidos' || 'Problemas' }}
            ‚è∞ Executado: $timestamp"
            
            # Push com retry
            echo "üöÄ Fazendo push das mudan√ßas..."
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Push realizado com sucesso (tentativa $i)"
                echo "PUSH_OK=true" >> $GITHUB_ENV
                break
              else
                echo "‚ö†Ô∏è Falha no push (tentativa $i)"
                sleep 5
                if [ $i -eq 3 ]; then
                  echo "‚ùå Push falhou ap√≥s 3 tentativas"
                  echo "PUSH_OK=false" >> $GITHUB_ENV
                fi
              fi
            done
          fi
      
      - name: Setup Pages
        if: env.FILES_OK == 'true'
        uses: actions/configure-pages@v3
        
      - name: Deploy para GitHub Pages
        if: env.FILES_OK == 'true'
        uses: actions/deploy-pages@v4
        with:
          path: public
        continue-on-error: true

      - name: Firebase opcional (sem erro se falhar)
        if: env.FILES_OK == 'true' && env.FIREBASE_PROJECT_ID != ''
        run: |
          echo "üî• Tentando Firebase (opcional)..."
          
          # S√≥ tentar se project ID estiver configurado
          if [ -n "${{ secrets.FIREBASE_PROJECT_ID }}" ]; then
            echo "Firebase Project ID detectado"
            
            # Tentar executar notifica√ß√µes se existir
            if [ -f "notification_sender.py" ]; then
              echo "üì± Executando notifica√ß√µes..."
              timeout 300 python notification_sender.py || echo "‚ö†Ô∏è Notifica√ß√µes falharam (n√£o cr√≠tico)"
            fi
          else
            echo "‚ÑπÔ∏è Firebase n√£o configurado (normal)"
          fi
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_VAPID_KEY: ${{ secrets.FIREBASE_VAPID_KEY }}
        continue-on-error: true
        
      - name: Resumo final da execu√ß√£o
        run: |
          echo ""
          echo "üéâ RESUMO DA EXECU√á√ÉO LIVELO ANALYTICS"
          echo "====================================="
          echo "‚è∞ Conclu√≠do: $(date +'%d/%m/%Y %H:%M:%S')"
          echo ""
          echo "üìä STATUS:"
          echo "Pipeline: ${{ env.PIPELINE_OK == 'true' && '‚úÖ Sucesso' || '‚ùå Problemas' }}"
          echo "Arquivos: ${{ env.FILES_OK == 'true' && '‚úÖ V√°lidos' || '‚ùå Problemas' }}"
          echo "Push: ${{ env.PUSH_OK == 'true' && '‚úÖ Realizado' || '‚ö†Ô∏è Problemas' }}"
          echo ""
          echo "üåê ACESSO:"
          echo "üì± GitHub Pages: https://gcaressato.github.io/livelo_scraper/"
          echo ""
          
          # Status final baseado nos resultados cr√≠ticos
          if [ "${{ env.FILES_OK }}" = "true" ]; then
            echo "‚úÖ Execu√ß√£o bem-sucedida!"
            echo "::notice::Sistema Livelo Analytics funcionando"
          else
            echo "‚ùå Execu√ß√£o com problemas!"
            echo "::error::Verificar logs para detalhes"
            exit 1
          fi
