name: Livelo Partners Scraper
on:
  schedule:
    - cron: '0 12 * * *'  # Executa todos os dias √†s 12:00 UTC
  workflow_dispatch:  # Permite execu√ß√£o manual

permissions:
  contents: write
  pages: write
  id-token: write
  issues: write

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        
      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Configurar Chrome
        uses: browser-actions/setup-chrome@latest
        
      - name: Instalar depend√™ncias
        run: |
          pip install selenium webdriver-manager pandas openpyxl selenium-stealth plotly numpy requests
          # Verificar vers√£o do Selenium e Chrome
          python -c "import selenium; print(f'Selenium version: {selenium.__version__}')"
          google-chrome --version
          
      - name: Verificar ambiente
        run: |
          echo "Diret√≥rio atual: $(pwd)"
          echo "Conte√∫do do diret√≥rio: $(ls -la)"
          
      - name: Criar diret√≥rios para logs e sa√≠da
        run: |
          mkdir -p logs
          mkdir -p relatorios
          
      - name: Executar scraper diretamente (para depura√ß√£o)
        run: |
          python livelo_scraper.py 2>&1 | tee scraper_debug.log
        continue-on-error: true
          
      - name: Executar script principal
        run: |
          python main.py 2>&1 | tee output.log
        continue-on-error: true

      # DEBUG - Verificar secrets (SEM EXPOR VALORES)
      - name: Debug configura√ß√µes Firebase
        run: |
          echo "üîç Verificando secrets (sem expor valores)..."
          echo "API Key presente: $([[ -n '${{ secrets.FIREBASE_API_KEY }}' ]] && echo 'SIM' || echo 'N√ÉO')"
          echo "Project ID presente: $([[ -n '${{ secrets.FIREBASE_PROJECT_ID }}' ]] && echo 'SIM' || echo 'N√ÉO')"
          echo "Sender ID presente: $([[ -n '${{ secrets.FIREBASE_SENDER_ID }}' ]] && echo 'SIM' || echo 'N√ÉO')"
          echo "App ID presente: $([[ -n '${{ secrets.FIREBASE_APP_ID }}' ]] && echo 'SIM' || echo 'N√ÉO')"
          echo "VAPID Key presente: $([[ -n '${{ secrets.FIREBASE_VAPID_KEY }}' ]] && echo 'SIM' || echo 'N√ÉO')"
          echo "Server Key presente: $([[ -n '${{ secrets.FIREBASE_SERVER_KEY }}' ]] && echo 'SIM' || echo 'N√ÉO')"
        
      # VALIDA√á√ÉO INTELIGENTE DE DADOS
      - name: Validar qualidade dos dados
        id: validate
        run: |
          python -c "
          import pandas as pd
          from datetime import datetime, timedelta
          import os
          
          success = True
          
          try:
              # Verificar se arquivo Excel existe
              if not os.path.exists('livelo_parceiros.xlsx'):
                  print('‚ùå Arquivo Excel n√£o encontrado!')
                  success = False
              else:
                  df = pd.read_excel('livelo_parceiros.xlsx')
                  
                  # Verificar se dados s√£o recentes (√∫ltimas 24h)
                  df['Timestamp'] = pd.to_datetime(df['Timestamp'])
                  latest_date = df['Timestamp'].max()
                  now = datetime.now()
                  
                  if (now - latest_date).total_seconds() > 86400:  # 24 horas
                      print(f'‚ö†Ô∏è Dados podem estar antigos! √öltimo: {latest_date}')
                  
                  # Verificar quantidade m√≠nima
                  if len(df) < 30:
                      print(f'‚ö†Ô∏è Poucos dados coletados: {len(df)} registros')
                  else:
                      print(f'‚úÖ Dados validados: {len(df)} registros, √∫ltimo em {latest_date}')
              
              # Verificar se HTML foi gerado
              if not os.path.exists('relatorio_livelo.html'):
                  print('‚ùå HTML n√£o foi gerado!')
                  success = False
              else:
                  print('‚úÖ HTML gerado com sucesso')
              
              if success:
                  print('VALIDATION_SUCCESS=true')
              else:
                  print('VALIDATION_FAILED=true')
                  
          except Exception as e:
              print(f'‚ùå Erro na valida√ß√£o: {e}')
              print('VALIDATION_ERROR=true')
          " 2>&1 | tee validation.log
        continue-on-error: true
        
      # ============ SISTEMA DE NOTIFICA√á√ïES FIREBASE ============
      
      - name: Verificar se todos os secrets est√£o dispon√≠veis
        id: check_secrets
        run: |
          missing_secrets=0
          
          if [[ -z "${{ secrets.FIREBASE_API_KEY }}" ]]; then
            echo "‚ùå FIREBASE_API_KEY ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_PROJECT_ID }}" ]]; then
            echo "‚ùå FIREBASE_PROJECT_ID ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_SENDER_ID }}" ]]; then
            echo "‚ùå FIREBASE_SENDER_ID ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_APP_ID }}" ]]; then
            echo "‚ùå FIREBASE_APP_ID ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_VAPID_KEY }}" ]]; then
            echo "‚ùå FIREBASE_VAPID_KEY ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ -z "${{ secrets.FIREBASE_SERVER_KEY }}" ]]; then
            echo "‚ùå FIREBASE_SERVER_KEY ausente"
            missing_secrets=$((missing_secrets + 1))
          fi
          
          if [[ $missing_secrets -eq 0 ]]; then
            echo "‚úÖ Todos os secrets Firebase est√£o configurados"
            echo "FIREBASE_READY=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå $missing_secrets secrets ausentes - Firebase ser√° desabilitado"
            echo "FIREBASE_READY=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Criar Service Worker Firebase v9
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          cat > sw.js << 'EOF'
          // Service Worker para Firebase Messaging v9
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js');
          importScripts('https://www.gstatic.com/firebasejs/9.0.0/firebase-messaging-compat.js');
      
          console.log('[SW] Service Worker carregando...');
      
          const firebaseConfig = {
              apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
              authDomain: "FIREBASE_PROJECT_ID_PLACEHOLDER.firebaseapp.com",
              projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
              storageBucket: "FIREBASE_PROJECT_ID_PLACEHOLDER.appspot.com",
              messagingSenderId: "FIREBASE_SENDER_ID_PLACEHOLDER",
              appId: "FIREBASE_APP_ID_PLACEHOLDER"
          };
      
          let messaging;
      
          try {
              if (!firebase.apps.length) {
                  firebase.initializeApp(firebaseConfig);
              }
              
              messaging = firebase.messaging();
              console.log('[SW] Firebase Messaging inicializado');
              
              messaging.onBackgroundMessage(function(payload) {
                  console.log('[SW] Mensagem em background recebida:', payload);
                  
                  const notificationTitle = payload.notification?.title || 'Livelo Analytics';
                  const notificationOptions = {
                      body: payload.notification?.body || 'Nova oferta dispon√≠vel!',
                      icon: 'https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L',
                      badge: 'https://via.placeholder.com/96x96/ff0a8c/ffffff?text=L',
                      tag: 'livelo-offer',
                      requireInteraction: true,
                      data: payload.data || {},
                      actions: [
                          {
                              action: 'view',
                              title: 'üëÄ Ver Oferta'
                          },
                          {
                              action: 'dismiss',
                              title: '‚úñÔ∏è Dispensar'
                          }
                      ]
                  };
                  
                  return self.registration.showNotification(notificationTitle, notificationOptions);
              });
              
          } catch (error) {
              console.error('[SW] Erro ao inicializar Firebase:', error);
          }
      
          self.addEventListener('notificationclick', function(event) {
              console.log('[SW] Clique na notifica√ß√£o:', event.action);
              event.notification.close();
              
              if (event.action === 'view') {
                  event.waitUntil(
                      clients.openWindow('https://gcaressato.github.io/livelo_scraper/')
                  );
              }
          });
      
          self.addEventListener('activate', function(event) {
              console.log('[SW] Service Worker ativado');
              event.waitUntil(self.clients.claim());
          });
      
          self.addEventListener('install', function(event) {
              console.log('[SW] Service Worker instalado');
              self.skipWaiting();
          });
          EOF
          
          echo "‚úÖ Service Worker criado com placeholders"
      
      - name: Criar manifest.json PWA
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          cat > manifest.json << 'EOF'
          {
            "name": "Livelo Analytics Pro",
            "short_name": "Livelo",
            "description": "Dashboard anal√≠tico para ofertas Livelo com notifica√ß√µes push",
            "start_url": "./",
            "scope": "./",
            "display": "standalone",
            "background_color": "#151f4f",
            "theme_color": "#ff0a8c",
            "orientation": "portrait-primary",
            "icons": [
              {
                "src": "https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L",
                "sizes": "192x192",
                "type": "image/png",
                "purpose": "maskable any"
              },
              {
                "src": "https://via.placeholder.com/512x512/ff0a8c/ffffff?text=L", 
                "sizes": "512x512",
                "type": "image/png",
                "purpose": "maskable any"
              }
            ],
            "gcm_sender_id": "FIREBASE_SENDER_ID_PLACEHOLDER"
          }
          EOF
          
          echo "‚úÖ Manifest PWA criado"
      
      - name: Criar arquivo de configura√ß√£o Firebase din√¢mico
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          cat > firebase-config-runtime.js << 'EOF'
          // Configura√ß√£o Firebase din√¢mica (gerada pelo GitHub Actions)
          window.firebaseConfig = {
              apiKey: "FIREBASE_API_KEY_PLACEHOLDER",
              authDomain: "FIREBASE_PROJECT_ID_PLACEHOLDER.firebaseapp.com",
              projectId: "FIREBASE_PROJECT_ID_PLACEHOLDER",
              storageBucket: "FIREBASE_PROJECT_ID_PLACEHOLDER.appspot.com",
              messagingSenderId: "FIREBASE_SENDER_ID_PLACEHOLDER",
              appId: "FIREBASE_APP_ID_PLACEHOLDER"
          };
          
          window.firebaseVapidKey = "FIREBASE_VAPID_KEY_PLACEHOLDER";
          
          console.log('üî• Firebase config carregada:', window.firebaseConfig.projectId);
          EOF
          
          echo "‚úÖ Configura√ß√£o Firebase din√¢mica criada"
            
      - name: Substituir placeholders Firebase nos arquivos
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          echo "üîß Substituindo configura√ß√µes Firebase..."
          
          # Lista de arquivos para atualizar
          files_to_update="relatorio_livelo.html sw.js manifest.json firebase-config-runtime.js"
          
          for file in $files_to_update; do
            if [ -f "$file" ]; then
              echo "Atualizando $file..."
              
              # Substituir com escape de caracteres especiais
              sed -i "s|FIREBASE_API_KEY_PLACEHOLDER|${{ secrets.FIREBASE_API_KEY }}|g" "$file"
              sed -i "s|FIREBASE_PROJECT_ID_PLACEHOLDER|${{ secrets.FIREBASE_PROJECT_ID }}|g" "$file"
              sed -i "s|FIREBASE_SENDER_ID_PLACEHOLDER|${{ secrets.FIREBASE_SENDER_ID }}|g" "$file"
              sed -i "s|FIREBASE_APP_ID_PLACEHOLDER|${{ secrets.FIREBASE_APP_ID }}|g" "$file"
              sed -i "s|FIREBASE_VAPID_KEY_PLACEHOLDER|${{ secrets.FIREBASE_VAPID_KEY }}|g" "$file"
              
              echo "‚úÖ $file atualizado"
            else
              echo "‚ö†Ô∏è Arquivo $file n√£o encontrado"
            fi
          done
          
          echo "‚úÖ Configura√ß√£o Firebase aplicada"
      
      - name: Validar configura√ß√µes Firebase aplicadas
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          echo "üîç Validando substitui√ß√µes Firebase..."
          
          for file in "sw.js" "manifest.json" "firebase-config-runtime.js"; do
            if [ -f "$file" ]; then
              echo "Verificando $file..."
              
              # Verificar se ainda h√° placeholders n√£o substitu√≠dos
              if grep -q "PLACEHOLDER" "$file"; then
                echo "‚ùå Placeholders n√£o substitu√≠dos em $file:"
                grep -n "PLACEHOLDER" "$file" || true
              else
                echo "‚úÖ $file - Todos os placeholders substitu√≠dos"
              fi
              
              # Verificar tamanho
              size=$(wc -c < "$file")
              echo "üìè Tamanho de $file: $size bytes"
            fi
          done
          
          echo "‚úÖ Valida√ß√£o Firebase conclu√≠da"
      
      - name: Enviar notifica√ß√µes push para usu√°rios
        if: steps.check_secrets.outputs.FIREBASE_READY == 'true'
        run: |
          echo "üîî Iniciando envio de notifica√ß√µes push..."
          python notification_sender.py 2>&1 | tee notifications.log
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_SERVER_KEY: ${{ secrets.FIREBASE_SERVER_KEY }}
        continue-on-error: true
      
      - name: Criar fallback se Firebase indispon√≠vel
        if: steps.check_secrets.outputs.FIREBASE_READY == 'false'
        run: |
          echo "‚ö†Ô∏è Firebase n√£o configurado - criando arquivos de fallback"
          
          # Service Worker m√≠nimo
          cat > sw.js << 'EOF'
          // Service Worker b√°sico (Firebase desabilitado)
          console.log('[SW] Service Worker b√°sico carregado - Firebase desabilitado');
          
          self.addEventListener('install', function(event) {
              console.log('[SW] Service Worker instalado (modo b√°sico)');
              self.skipWaiting();
          });
          
          self.addEventListener('activate', function(event) {
              console.log('[SW] Service Worker ativado (modo b√°sico)');
              event.waitUntil(self.clients.claim());
          });
          EOF
          
          # Manifest b√°sico
          cat > manifest.json << 'EOF'
          {
            "name": "Livelo Analytics",
            "short_name": "Livelo",
            "description": "Dashboard anal√≠tico para ofertas Livelo",
            "start_url": "./",
            "scope": "./",
            "display": "standalone",
            "background_color": "#151f4f",
            "theme_color": "#ff0a8c",
            "orientation": "portrait-primary",
            "icons": [
              {
                "src": "https://via.placeholder.com/192x192/ff0a8c/ffffff?text=L",
                "sizes": "192x192",
                "type": "image/png",
                "purpose": "maskable any"
              }
            ]
          }
          EOF
          
          echo "‚úÖ Arquivos de fallback criados"
      
      # ============ FIM NOTIFICA√á√ïES ============
        
      - name: Verificar falhas na execu√ß√£o
        run: |
          if cat output.log | grep -q "Falha no scraper\|Falha no reporter\|ERRO FATAL"; then
            echo "::warning::Falhas detectadas na execu√ß√£o!"
            grep -A 10 "Falha\|ERRO" output.log || true
            echo "SCRAPING_FALHOU=true" >> $GITHUB_ENV
          else
            echo "Nenhuma falha detectada na execu√ß√£o."
            echo "SCRAPING_FALHOU=false" >> $GITHUB_ENV
          fi
      
      # CRIAR ISSUE AUTOM√ÅTICA SE FALHOU
      - name: Criar issue se scraper falhou
        if: env.SCRAPING_FALHOU == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const title = `üö® Scraper falhou em ${new Date().toLocaleString('pt-BR')}`;
            const body = `
            ## ‚ùå Falha no Scraper Livelo
            
            **‚è∞ Hor√°rio:** ${new Date().toLocaleString('pt-BR', {timeZone: 'America/Sao_Paulo'})}
            **üîó Logs:** [Ver detalhes](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            
            ### Poss√≠veis causas:
            - [ ] Site mudou estrutura HTML
            - [ ] Elementos foram alterados  
            - [ ] Timeout de conex√£o
            - [ ] Erro no processamento dos dados
            
            ### ‚ö†Ô∏è A√ß√£o necess√°ria:
            1. Verificar logs do workflow
            2. Testar scraper localmente
            3. Ajustar seletores se necess√°rio
            4. Fechar esta issue ap√≥s corre√ß√£o
            
            ---
            *Issue criada automaticamente pelo GitHub Actions*
            `;
            
            // Verificar se j√° existe issue aberta
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'scraper-failure'
            });
            
            if (existingIssues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['scraper-failure', 'urgent']
              });
              
              console.log('üìß Issue criada - voc√™ receber√° email do GitHub automaticamente!');
            } else {
              console.log('Issue de falha j√° existe, n√£o criando duplicata');
            }
      
      - name: Listar arquivos de diagn√≥stico
        run: |
          echo "üìÅ Arquivos HTML gerados:"
          ls -la *.html 2>/dev/null || echo "Nenhum arquivo HTML encontrado"
          
          echo "üìÅ Arquivos de log gerados:"
          ls -la *.log 2>/dev/null || echo "Nenhum arquivo de log encontrado"
          
          echo "üìÅ Screenshots gerados:"
          ls -la *.png 2>/dev/null || echo "Nenhum screenshot encontrado"
          
          echo "üìÅ Arquivos PWA/Firebase:"
          ls -la sw.js manifest.json firebase-config-runtime.js 2>/dev/null || echo "Arquivos PWA n√£o encontrados"
          
          echo "üìÅ Arquivos de dados:"
          ls -la *.xlsx *.json 2>/dev/null || echo "Arquivos de dados n√£o encontrados"
      
      - name: Configurar Git para commit
        run: |
          git config --local user.email "actions@github.com"
          git config --local user.name "GitHub Actions"
          
      - name: Commit e push dos novos dados
        run: |
          # Copiar logs com timestamp
          timestamp=$(date +%Y%m%d_%H%M%S)
          
          if [ -f "output.log" ]; then
            cp output.log "logs/scraper_${timestamp}.log"
          fi
          
          if [ -f "notifications.log" ]; then
            cp notifications.log "logs/notifications_${timestamp}.log"
          fi
          
          if [ -f "validation.log" ]; then
            cp validation.log "logs/validation_${timestamp}.log"
          fi
          
          # Adicionar arquivos principais
          git add -f *.html *.xlsx *.json sw.js manifest.json firebase-config-runtime.js 2>/dev/null || true
          
          # Adicionar logs
          git add logs/ relatorios/ 2>/dev/null || true
          
          # Adicionar arquivos de debug
          git add -f debug_*.* *.log 2>/dev/null || true
          
          # Verificar se h√° algo para comitar
          if git diff --staged --quiet; then
            echo "‚úÖ Nenhuma mudan√ßa para comitar"
          else
            # Fazer commit
            commit_message="üìä Atualiza√ß√£o autom√°tica Livelo Analytics [$(date +'%d/%m/%Y %H:%M')]
            
            üîß Firebase: ${{ steps.check_secrets.outputs.FIREBASE_READY == 'true' && 'Configurado' || 'Desabilitado' }}
            üìà Scraping: ${{ env.SCRAPING_FALHOU == 'true' && 'Falhou' || 'Sucesso' }}
            ‚è∞ Timestamp: ${timestamp}"
            
            git commit -m "$commit_message"
            
            # Push com retry
            for i in {1..3}; do
              if git push; then
                echo "‚úÖ Push realizado com sucesso (tentativa $i)"
                break
              else
                echo "‚ö†Ô∏è Falha no push (tentativa $i), tentando novamente..."
                sleep 5
              fi
            done
          fi
      
      # ============ SE√á√ÉO PWA + GITHUB PAGES ============
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Configurar diret√≥rio de publica√ß√£o
        run: |
          mkdir -p ./public
          
          echo "üìÅ Copiando arquivos para o diret√≥rio public..."
          
          # Copiar HTML principal
          if [ -f "relatorio_livelo.html" ]; then
            cp relatorio_livelo.html ./public/index.html
            echo "‚úÖ HTML principal copiado"
          else
            echo "‚ùå relatorio_livelo.html n√£o encontrado - criando p√°gina de erro"
            cat > ./public/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="pt-BR">
          <head>
            <title>Livelo Analytics - Em Manuten√ß√£o</title>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <style>
              body { 
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                text-align: center; 
                padding: 50px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                min-height: 100vh;
                margin: 0;
                display: flex;
                align-items: center;
                justify-content: center;
              }
              .container { 
                max-width: 600px; 
                background: rgba(255,255,255,0.1);
                padding: 40px;
                border-radius: 20px;
                backdrop-filter: blur(10px);
              }
              .error { color: #ffeb3b; font-size: 1.2em; }
              .info { color: #e0e0e0; margin-top: 20px; }
              .loading { 
                animation: pulse 2s infinite;
                font-size: 3em;
                margin-bottom: 20px;
              }
              @keyframes pulse {
                0% { opacity: 0.6; }
                50% { opacity: 1; }
                100% { opacity: 0.6; }
              }
            </style>
          </head>
          <body>
            <div class="container">
              <div class="loading">üîß</div>
              <h1>Livelo Analytics</h1>
              <p class="error">Dashboard temporariamente indispon√≠vel</p>
              <p class="info">O sistema est√° processando novos dados. Tente novamente em alguns minutos.</p>
              <p class="info"><small>√öltima tentativa: $(date +'%d/%m/%Y %H:%M')</small></p>
              <p class="info">
                <a href="https://github.com/gcaressato/livelo_scraper/actions" 
                   style="color: #81c784; text-decoration: none;">
                  üìä Ver Status da Execu√ß√£o
                </a>
              </p>
            </div>
          </body>
          </html>
          EOF
          fi
          
          # Copiar arquivos PWA
          for file in manifest.json sw.js firebase-config-runtime.js; do
            if [ -f "$file" ]; then
              cp "$file" ./public/
              echo "‚úÖ $file copiado"
            else
              echo "‚ö†Ô∏è $file n√£o encontrado"
            fi
          done
          
          # Copiar outros arquivos √∫teis
          cp -f *.xlsx ./public/ 2>/dev/null || echo "üìä Nenhum arquivo Excel para copiar"
          cp -f *.css ./public/ 2>/dev/null || echo "üé® Nenhum CSS adicional para copiar"
          
          echo "üìÇ Conte√∫do do diret√≥rio public:"
          ls -la ./public/
          
      - name: Setup Pages
        uses: actions/configure-pages@v3
        
      - name: Deploy para GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: public
          branch: gh-pages
          clean: true

      # ============ FIREBASE HOSTING DEPLOY ============
      
      - name: Verificar Service Account do Firebase
        id: check_firebase_service_account
        run: |
          if [[ -n "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]]; then
            echo "‚úÖ FIREBASE_SERVICE_ACCOUNT configurado"
            echo "FIREBASE_SA_READY=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå FIREBASE_SERVICE_ACCOUNT ausente"
            echo "üí° Para ativar Firebase Hosting:"
            echo "   1. Crie Service Account no Google Cloud Console"
            echo "   2. Baixe JSON key e configure como secret FIREBASE_SERVICE_ACCOUNT"
            echo "   3. Veja o guia em: FIREBASE_SETUP_GUIDE.md"
            echo "FIREBASE_SA_READY=false" >> $GITHUB_OUTPUT
          fi

      - name: Instalar depend√™ncia google-auth (se necess√°rio)
        if: steps.check_firebase_service_account.outputs.FIREBASE_SA_READY == 'true'
        run: |
          pip install google-auth google-auth-oauthlib google-auth-httplib2
          echo "‚úÖ Depend√™ncias Firebase instaladas"

      - name: Criar arquivos de configura√ß√£o do Firebase
        if: steps.check_firebase_service_account.outputs.FIREBASE_SA_READY == 'true'
        run: |
          # Criar firebase.json
          cat > firebase.json << 'EOF'
          {
            "hosting": {
              "public": "public",
              "ignore": [
                "firebase.json",
                "**/.*",
                "**/node_modules/**",
                "**/*.log",
                "**/backup_*/**"
              ],
              "rewrites": [
                {
                  "source": "**",
                  "destination": "/index.html"
                }
              ],
              "headers": [
                {
                  "source": "/sw.js",
                  "headers": [
                    {
                      "key": "Cache-Control",
                      "value": "no-cache, no-store, must-revalidate"
                    },
                    {
                      "key": "Service-Worker-Allowed",
                      "value": "/"
                    }
                  ]
                },
                {
                  "source": "/manifest.json",
                  "headers": [
                    {
                      "key": "Cache-Control",
                      "value": "public, max-age=3600"
                    }
                  ]
                },
                {
                  "source": "/firebase-config-runtime.js",
                  "headers": [
                    {
                      "key": "Cache-Control",
                      "value": "public, max-age=300"
                    }
                  ]
                }
              ]
            }
          }
          EOF
          
          # Criar .firebaserc
          cat > .firebaserc << 'EOF'
          {
            "projects": {
              "default": "livel-analytics"
            },
            "targets": {
              "livel-analytics": {
                "hosting": {
                  "livelo-analytics": [
                    "livel-analytics"
                  ]
                }
              }
            }
          }
          EOF
          
          echo "‚úÖ Arquivos de configura√ß√£o Firebase criados"
          echo "üìÑ firebase.json: $(wc -c < firebase.json) bytes"
          echo "üìÑ .firebaserc: $(wc -c < .firebaserc) bytes"

      - name: Deploy para Firebase Hosting
        if: steps.check_firebase_service_account.outputs.FIREBASE_SA_READY == 'true'
        uses: FirebaseExtended/action-hosting-deploy@v0
        id: firebase_deploy
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: livel-analytics
          entryPoint: .
        continue-on-error: true

      - name: Verificar resultado do deploy Firebase
        if: steps.check_firebase_service_account.outputs.FIREBASE_SA_READY == 'true'
        run: |
          if [[ "${{ steps.firebase_deploy.outcome }}" == "success" ]]; then
            echo "üéâ Firebase Hosting deploy bem-sucedido!"
            echo "üîó URL: https://livel-analytics.web.app/"
            echo "FIREBASE_DEPLOY_SUCCESS=true" >> $GITHUB_ENV
          else
            echo "‚ö†Ô∏è Firebase Hosting deploy falhou"
            echo "üí° Verifique:"
            echo "   - Service Account tem permiss√µes Firebase Hosting Admin"
            echo "   - Firebase Hosting API est√° habilitada"
            echo "   - Project ID 'livel-analytics' est√° correto"
            echo "FIREBASE_DEPLOY_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: Verificar deploy e URLs
        run: |
          echo "üîç Verificando URLs ap√≥s deploy..."
          
          # Aguardar deploy
          sleep 15
          
          # URLs para testar
          base_url="https://gcaressato.github.io/livelo_scraper"
          urls_to_test=(
            "$base_url/"
            "$base_url/sw.js"
            "$base_url/manifest.json"
          )
          
          for url in "${urls_to_test[@]}"; do
            echo "Testando: $url"
            if curl -I "$url" -s -m 10 | grep -q "200 OK"; then
              echo "‚úÖ $url - OK"
            else
              echo "‚ùå $url - Falha"
            fi
          done
          
          echo "üåê Site principal: $base_url"
          echo "üî• Firebase: ${{ steps.check_secrets.outputs.FIREBASE_READY == 'true' && 'Ativo' || 'Desabilitado' }}"
        continue-on-error: true

      # ============ RESUMO FINAL ============
      
      - name: Resumo da execu√ß√£o
        run: |
          echo "
          üìä RESUMO DA EXECU√á√ÉO LIVELO ANALYTICS
          ========================================
          ‚è∞ Hor√°rio: $(date +'%d/%m/%Y %H:%M:%S %Z')
          üìÅ Arquivos no public: $(ls -1 ./public/ 2>/dev/null | wc -l) arquivos
          
          üîç STATUS DOS COMPONENTES:
          ‚úÖ Scraping: ${{ env.SCRAPING_FALHOU == 'true' && '‚ùå FALHOU' || '‚úÖ SUCESSO' }}
          üåê GitHub Pages: ‚úÖ Deployado
          üî• Firebase Messaging: ${{ steps.check_secrets.outputs.FIREBASE_READY == 'true' && '‚úÖ Ativo' || '‚ö†Ô∏è Desabilitado' }}
          üè† Firebase Hosting: Status dispon√≠vel nos logs acima
          üîî Notifica√ß√µes: ${{ steps.check_secrets.outputs.FIREBASE_READY == 'true' && '‚úÖ Processadas' || '‚ö†Ô∏è Puladas' }}
          üìß Issues: ${{ env.SCRAPING_FALHOU == 'true' && 'üìß Issue criada' || '‚úÖ Nenhuma necess√°ria' }}
          
          üîß ARQUIVOS PWA:
          - Service Worker: $([ -f './public/sw.js' ] && echo '‚úÖ Criado' || echo '‚ùå Faltando')
          - Manifest: $([ -f './public/manifest.json' ] && echo '‚úÖ Criado' || echo '‚ùå Faltando')
          - Firebase Config: $([ -f './public/firebase-config-runtime.js' ] && echo '‚úÖ Criado' || echo '‚ùå Faltando')
          
          üìà DADOS:
          - Excel: $([ -f './public/livelo_parceiros.xlsx' ] && echo '‚úÖ Dispon√≠vel' || echo '‚ùå Ausente')
          - HTML: $([ -f './public/index.html' ] && echo '‚úÖ Dispon√≠vel' || echo '‚ùå Ausente')
          
          üåç ACESSO:
          üìñ GitHub Pages: https://gcaressato.github.io/livelo_scraper/
          üî• Firebase Hosting: https://livel-analytics.web.app/ (verificar logs acima para status)
          "
          
          # Mostrar estat√≠sticas de notifica√ß√µes se dispon√≠veis
          if [ -f "notification_stats.json" ]; then
            echo "üìä ESTAT√çSTICAS DE NOTIFICA√á√ïES:"
            cat notification_stats.json | python3 -m json.tool 2>/dev/null || echo "Erro ao exibir estat√≠sticas"
          fi
          
          # Status final
          if [ "${{ env.SCRAPING_FALHOU }}" = "true" ]; then
            echo "::warning::‚ö†Ô∏è Scraper falhou mas deploy foi mantido com dados existentes"
          elif [ "${{ env.FIREBASE_DEPLOY_STATUS }}" = "success" ]; then
            echo "::notice::üéâ DEPLOY DUAL completado com sucesso!"
            echo "üåü Dispon√≠vel em:"
            echo "   üìñ GitHub Pages: https://gcaressato.github.io/livelo_scraper/"
            echo "   üî• Firebase: https://livel-analytics.web.app/"
          else
            echo "::notice::‚úÖ Deploy GitHub Pages conclu√≠do"
            echo "üí° Para ativar Firebase Hosting, configure FIREBASE_SERVICE_ACCOUNT"
          fi
